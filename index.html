<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçá Grapes Fri Chat</title>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --bg-chat: #f8f9fa;
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --border-color: #e0e0e0;
            --success-color: #00b894;
            --error-color: #e17055;
            --warning-color: #fdcb6e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-primary);
        }

        .chat-container {
            width: 1200px;
            height: 700px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            display: flex;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .sidebar {
            width: 300px;
            background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
            border-right: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 18px 25px;
            background: var(--primary-gradient);
            color: white;
            text-align: center;
            position: relative;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h2 {
            font-size: 17px;
            margin-bottom: 3px;
            line-height: 1.2;
        }

        .sidebar-header .user-info {
            font-size: 13px;
            opacity: 0.9;
            line-height: 1.3;
            text-align: center;
            font-weight: 600;
            margin-top: 3px;
        }

        .theme-selector {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .theme-btn {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .theme-btn:hover, .theme-btn.active {
            transform: scale(1.2);
            border-color: white;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        .theme-claro { background: linear-gradient(45deg, #74b9ff, #0984e3); }
        .theme-oscuro { background: linear-gradient(45deg, #2d3436, #636e72); }
        .theme-gris { background: linear-gradient(45deg, #b2bec3, #74b9ff); }
        .theme-rosado { background: linear-gradient(45deg, #fd79a8, #e84393); }
        .theme-verde { background: linear-gradient(45deg, #00b894, #00cec9); }

        .users-section {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .section-title {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .user-list {
            margin-bottom: 20px;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 3px 0;
            border-radius: 8px;
            background: white;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .user-item:hover {
            background: #f1f3f4;
            transform: translateX(5px);
        }

        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            margin-right: 8px;
            animation: pulse 2s infinite;
            flex-shrink: 0;
            position: relative;
        }

        /* Estados de usuario mejorados */
        .user-status.online { 
            background: var(--success-color);
            box-shadow: 0 0 8px rgba(0, 184, 148, 0.5);
        }
        
        .user-status.away { 
            background: var(--warning-color);
            box-shadow: 0 0 8px rgba(253, 203, 110, 0.5);
        }
        
        .user-status.busy { 
            background: var(--error-color);
            box-shadow: 0 0 8px rgba(225, 112, 85, 0.5);
        }
        
        .user-status.invisible { 
            background: #95a5a6;
            box-shadow: none;
            animation: none;
        }

        .user-status.streaming {
            background: linear-gradient(45deg, #9b59b6, #e74c3c);
            animation: streamingPulse 1.5s infinite;
        }

        @keyframes streamingPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(155, 89, 182, 0.7);
            }
            50% {
                box-shadow: 0 0 0 6px rgba(155, 89, 182, 0);
            }
        }

        /* Selector de estado */
        .status-selector {
            position: absolute;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 150px;
            top: 100%;
            right: 0;
        }

        .status-option {
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .status-option:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .status-option .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Indicador de actividad personalizado */
        .custom-status {
            font-size: 11px;
            color: var(--text-secondary);
            font-style: italic;
            margin-left: 5px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .user-role {
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            padding: 1px 4px;
            border-radius: 6px;
            background: rgba(0,0,0,0.1);
            color: white;
            line-height: 1;
            flex-shrink: 0;
        }

        .user-label {
            font-size: 9px;
            color: var(--text-secondary);
            font-style: italic;
            opacity: 0.7;
            margin-left: auto;
            flex-shrink: 0;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 184, 148, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 184, 148, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 184, 148, 0); }
        }

        .stats-section {
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-top: 1px solid var(--border-color);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 12px;
        }

        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: var(--primary-gradient);
            color: white;
            padding: 18px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .chat-title {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .chat-title h1 {
            font-size: 22px;
            margin-bottom: 3px;
            line-height: 1.2;
        }

        .chat-subtitle {
            font-size: 13px;
            opacity: 0.85;
            line-height: 1.3;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Nuevo selector de temas en el header */
        .theme-selector-header {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .theme-label {
            font-size: 12px;
            color: rgba(255,255,255,0.9);
            font-weight: 500;
            margin-right: 5px;
        }

        .theme-btn-header {
            width: 24px;
            height: 24px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .theme-btn-header:hover {
            transform: scale(1.15);
            border-color: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
        }

        .theme-btn-header.active {
            transform: scale(1.2);
            border-color: white;
            box-shadow: 0 0 20px rgba(255,255,255,0.5);
        }

        .theme-btn-header:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }

        .theme-btn-header:hover:before {
            width: 100%;
            height: 100%;
        }

        .control-btn {
            padding: 8px 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--bg-chat);
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(118, 75, 162, 0.05) 0%, transparent 50%);
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .message.sent {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            flex-shrink: 0;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            position: relative;
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent .message-content {
            background: var(--primary-gradient);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.sent .message-header {
            display: none !important; /* Ocultar header en mensajes enviados */
        }

        .message.received .message-content {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .message-user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .message-username {
            font-weight: 700;
            font-size: 13px;
            color: var(--text-primary);
            margin: 0;
        }

        .message-user-role {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 2px 6px;
            border-radius: 8px;
            background: rgba(0,0,0,0.1);
            color: white;
            line-height: 1;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            color: var(--text-secondary);
            font-weight: 500;
            flex-shrink: 0;
            margin-left: 8px;
        }

        .message-text {
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        /* Sistema de Menciones */
        .mention {
            background: rgba(102, 126, 234, 0.2);
            color: var(--primary-color);
            padding: 2px 6px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mention:hover {
            background: var(--primary-color);
            color: white;
        }

        .mention-popup {
            position: absolute;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            min-width: 150px;
        }

        .mention-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mention-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .mention-item img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        /* Mensajes de Voz */
        .voice-message {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(76, 190, 140, 0.1);
            border: 1px solid rgba(76, 190, 140, 0.3);
            border-radius: 20px;
            padding: 10px 15px;
            margin: 5px 0;
        }

        .voice-play-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: var(--success-color);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .voice-play-btn:hover {
            background: #00a085;
            transform: scale(1.1);
        }

        .voice-waveform {
            flex: 1;
            height: 30px;
            background: rgba(0, 184, 148, 0.2);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }

        .voice-progress {
            height: 100%;
            background: var(--success-color);
            border-radius: 15px;
            transition: width 0.1s;
        }

        .voice-duration {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .voice-record-btn {
            background: var(--error-color);
            position: relative;
            overflow: hidden;
        }

        .voice-record-btn.recording {
            animation: recordingPulse 1s infinite;
        }

        @keyframes recordingPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(225, 112, 85, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(225, 112, 85, 0);
            }
        }

        .voice-record-time {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-color);
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Reacciones a mensajes */
        .message-reactions {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .reaction-item {
            display: flex;
            align-items: center;
            gap: 3px;
            padding: 3px 8px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .reaction-item:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: scale(1.05);
        }

        .reaction-item.user-reacted {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .reaction-emoji {
            font-size: 14px;
        }

        .reaction-count {
            font-weight: 600;
            font-size: 11px;
        }

        .add-reaction-btn {
            padding: 3px 6px;
            background: rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-reaction-btn:hover {
            background: rgba(0,0,0,0.1);
            transform: scale(1.05);
        }

        /* Bot√≥n de reacci√≥n r√°pida */
        .message-actions {
            position: absolute;
            top: -30px;
            right: 10px;
            display: none;
            flex-direction: row;
            gap: 5px;
            background: white;
            padding: 5px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            z-index: 10;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .quick-reaction {
            width: 25px;
            height: 25px;
            border: none;
            background: transparent;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-reaction:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.2);
        }

        /* Sistema de B√∫squeda */
        .search-panel {
            background: #f8f9fa;
            border-bottom: 2px solid var(--border-color);
            padding: 15px 20px;
            transition: all 0.3s ease;
        }

        .search-container {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
        }

        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            outline: none;
            font-size: 14px;
            transition: all 0.3s;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }

        .search-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .search-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .search-result-item {
            padding: 10px 15px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-result-item:hover {
            background: #f1f3f4;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-user {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 13px;
        }

        .search-result-text {
            margin: 5px 0;
            font-size: 14px;
        }

        .search-result-time {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .search-highlight {
            background: yellow;
            font-weight: bold;
            padding: 1px 2px;
            border-radius: 2px;
        }

        /* Sistema de Respuestas */
        .reply-to-message {
            background: rgba(102, 126, 234, 0.1);
            border-left: 3px solid var(--primary-color);
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
            font-size: 12px;
            position: relative;
        }

        .reply-to-user {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 2px;
        }

        .reply-to-text {
            color: var(--text-secondary);
            font-style: italic;
            max-height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .reply-cancel {
            position: absolute;
            top: 2px;
            right: 5px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .reply-cancel:hover {
            color: var(--error-color);
        }

        .replying-to-indicator {
            background: rgba(102, 126, 234, 0.1);
            border-left: 3px solid var(--primary-color);
            padding: 8px 15px;
            margin: 10px 20px;
            border-radius: 0 10px 10px 0;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .message-reply-reference {
            background: rgba(0,0,0,0.05);
            border-left: 2px solid var(--primary-color);
            padding: 6px 10px;
            margin-bottom: 8px;
            border-radius: 0 6px 6px 0;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .message-reply-reference:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .reply-reference-user {
            font-weight: bold;
            color: var(--primary-color);
        }

        .reply-reference-text {
            color: var(--text-secondary);
            margin-top: 2px;
            max-height: 30px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-input-section {
            padding: 20px;
            background: white;
            border-top: 2px solid var(--border-color);
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .message-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            outline: none;
            font-size: 14px;
            transition: all 0.3s;
            resize: none;
            min-height: 50px;
            max-height: 100px;
            font-family: inherit;
        }

        .message-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
        }

        .input-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        /* Sistema de Archivos Mejorado */
        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            background: rgba(102, 126, 234, 0.05);
            margin: 10px 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .file-upload-area.dragover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }

        .file-item {
            position: relative;
            background: white;
            border-radius: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 200px;
        }

        .file-item img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .file-item .file-info {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .file-remove {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Mensajes con archivos */
        .message-file {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .message-file:hover {
            background: rgba(102, 126, 234, 0.15);
            transform: translateY(-1px);
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-gradient);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .file-size {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .file-download {
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 12px;
            cursor: pointer;
        }

        .send-btn {
            background: var(--primary-gradient);
            color: white;
        }

        .send-btn:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .emoji-btn {
            background: #f8f9fa;
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
        }

        .emoji-btn:hover {
            background: #e9ecef;
        }

        .login-container {
            width: 520px;
            background: white;
            padding: 45px;
            border-radius: 20px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.15);
            text-align: center;
            animation: loginSlideIn 0.6s ease-out;
        }

        @keyframes loginSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            margin-bottom: 35px;
        }

        .login-header h2 {
            font-size: 30px;
            margin-bottom: 8px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            font-style: italic;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
            text-align: left;
        }

        .form-label {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: block;
        }

        .login-input {
            padding: 15px 20px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            outline: none;
            font-size: 14px;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .login-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
            background: white;
        }

        .login-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .login-btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .login-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .login-btn:hover:before {
            left: 100%;
        }

        .btn-guest {
            background: linear-gradient(45deg, #4CBE8C, #45A084);
            color: white;
        }

        .btn-guest:hover {
            background: linear-gradient(45deg, #5DD8A6, #4CBE8C);
        }

        .btn-primary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #42A5F5, #2196F3);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(45deg, #FFB74D, #FF9800);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .status {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            font-size: 12px;
            z-index: 1000;
            transition: all 0.3s;
            animation: statusSlideIn 0.5s ease-out;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        @keyframes statusSlideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .status.online { 
            background: var(--success-color);
            box-shadow: 0 3px 12px rgba(0, 184, 148, 0.3);
        }
        
        .status.offline { 
            background: var(--error-color);
            box-shadow: 0 3px 12px rgba(225, 112, 85, 0.3);
        }
        
        .status.connecting { 
            background: var(--warning-color);
            color: var(--text-primary);
            box-shadow: 0 3px 12px rgba(253, 203, 110, 0.3);
        }

        .typing-indicator {
            padding: 10px 20px;
            background: #f1f3f4;
            border-radius: 20px;
            margin: 10px 0;
            font-style: italic;
            color: var(--text-secondary);
            animation: typingPulse 1.5s infinite;
        }

        @keyframes typingPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* Indicador de escritura mejorado */
        .typing-users-indicator {
            padding: 8px 20px;
            background: rgba(102, 126, 234, 0.1);
            border-left: 3px solid var(--primary-color);
            border-radius: 0 15px 15px 0;
            margin: 5px 0;
            font-size: 13px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideInTyping 0.3s ease-out;
            min-height: 40px;
        }

        @keyframes slideInTyping {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .typing-animation {
            display: flex;
            gap: 3px;
            align-items: center;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-dot:nth-child(1) { animation-delay: 0.0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .typing-users-list {
            font-weight: 600;
            flex: 1;
        }

        .typing-user-name {
            color: var(--primary-color);
            font-weight: bold;
        }

        /* Mensajes Privados y Salas */
        .chat-channels {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 10px 15px;
            max-height: 150px;
            overflow-y: auto;
        }

        .channel-tabs {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .channel-tab {
            padding: 5px 12px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .channel-tab.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .channel-tab:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .channel-tab.private {
            background: rgba(255, 152, 0, 0.1);
            border-color: rgba(255, 152, 0, 0.3);
        }

        .channel-tab.private.active {
            background: #ff9800;
            border-color: #ff9800;
        }

        .close-channel {
            margin-left: 3px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        .add-channel-btn {
            padding: 5px 10px;
            background: rgba(76, 190, 140, 0.1);
            border: 1px solid rgba(76, 190, 140, 0.3);
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            color: #4cbe8c;
            font-weight: 600;
        }

        .add-channel-btn:hover {
            background: rgba(76, 190, 140, 0.2);
        }

        /* Lista de Amigos */
        .friends-section {
            border-top: 1px solid var(--border-color);
            padding: 10px 15px;
            max-height: 120px;
            overflow-y: auto;
        }

        .friend-item {
            display: flex;
            align-items: center;
            padding: 5px 8px;
            margin: 2px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .friend-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .friend-status {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .friend-status.online { background: #4cbe8c; }
        .friend-status.offline { background: #95a5a6; }

        .friend-name {
            font-size: 11px;
            font-weight: 600;
            flex: 1;
        }

        .friend-actions {
            display: flex;
            gap: 3px;
        }

        .friend-action-btn {
            width: 16px;
            height: 16px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-btn {
            background: #74b9ff;
            color: white;
        }

        .block-btn {
            background: #e17055;
            color: white;
        }

        /* Autenticaci√≥n 2FA */
        .twofa-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .twofa-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .twofa-code-input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            text-align: center;
            letter-spacing: 5px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin: 15px 0;
        }

        /* Encuestas */
        .poll-container {
            background: rgba(102, 126, 234, 0.05);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .poll-question {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .poll-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .poll-option:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .poll-option.voted {
            background: var(--primary-color);
            color: white;
        }

        .poll-votes {
            margin-left: auto;
            font-size: 11px;
            font-weight: 600;
        }

        .poll-bar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 6px;
            transition: width 0.3s ease;
            z-index: -1;
        }

        /* Cifrado */
        .encrypted-message {
            position: relative;
        }

        .encrypted-indicator {
            display: inline-block;
            font-size: 10px;
            color: #4cbe8c;
            margin-left: 5px;
        }

        /* Modo Compacto */
        .compact-mode .message {
            margin-bottom: 5px;
        }

        .compact-mode .message-content {
            padding: 8px 12px;
        }

        .compact-mode .message-header {
            margin-bottom: 3px;
        }

        .compact-mode .sidebar {
            width: 200px;
        }

        /* Bots */
        .bot-message {
            background: linear-gradient(45deg, #a29bfe, #fd79a8) !important;
            color: white !important;
        }

        .bot-indicator {
            font-size: 10px;
            background: rgba(255,255,255,0.2);
            padding: 2px 5px;
            border-radius: 8px;
            margin-left: 5px;
        }

        /* Controles de interfaz */
        .interface-controls {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-left: 10px;
        }

        .interface-toggle {
            padding: 4px 8px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .interface-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        .interface-toggle.active {
            background: rgba(255,255,255,0.4);
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-left: 4px solid var(--success-color);
            z-index: 1000;
            animation: notificationSlideIn 0.5s ease-out;
        }

        @keyframes notificationSlideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .hidden { 
            display: none !important; 
        }

        /* üîê ESTILOS PARA SISTEMA DE SEGURIDAD */
        .intrusion-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 20px 25px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(231, 76, 60, 0.3);
            z-index: 10000;
            min-width: 300px;
            max-width: 500px;
            animation: alertPulse 0.5s ease-out;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        @keyframes alertPulse {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.05);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .alert-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .alert-content {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .intrusion-alert button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            float: right;
        }

        .intrusion-alert button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* Indicadores de seguridad */
        .security-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary-gradient);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s;
        }

        .security-indicator:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .security-indicator.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .security-indicator.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            animation: dangerPulse 2s infinite;
        }

        @keyframes dangerPulse {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
            }
            50% {
                box-shadow: 0 4px 15px rgba(231, 76, 60, 0.6);
            }
        }

        /* Mensajes del bot moderador mejorados */
        .bot-message {
            background: linear-gradient(45deg, #667eea, #764ba2) !important;
            border-left: 4px solid #ffd700 !important;
        }

        .bot-avatar {
            background: linear-gradient(45deg, #ffd700, #ffed4e) !important;
            color: #333 !important;
            font-size: 16px !important;
        }

        .message.bot-message .bot-indicator {
            background: rgba(255, 215, 0, 0.3);
            color: #ffd700;
            font-weight: 700;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 10px;
        }

        /* Alertas de notificaci√≥n mejoradas */
        .notification.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            border-left: 4px solid #f1c40f;
        }

        .notification.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-left: 4px solid #e74c3c;
        }

        .notification.info {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-left: 4px solid #74b9ff;
        }

        /* Estilos para panel de administraci√≥n */
        .admin-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .admin-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        /* üîê ESTILOS PARA AUTENTICACI√ìN DE ADMINISTRADOR */
        .admin-auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 15000;
            animation: authModalFadeIn 0.3s ease-out;
        }

        @keyframes authModalFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(5px);
            }
        }

        .admin-auth-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 40px;
            border-radius: 20px;
            max-width: 450px;
            width: 90%;
            color: white;
            box-shadow: 0 30px 60px rgba(102, 126, 234, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h3 {
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .auth-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .auth-form {
            margin-bottom: 20px;
        }

        .admin-auth-input {
            width: 100%;
            padding: 15px 20px;
            margin: 10px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .admin-auth-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .admin-auth-input:focus {
            border-color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        .auth-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .auth-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .auth-btn.primary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .auth-btn.primary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
        }

        .auth-btn.secondary {
            background: rgba(231, 76, 60, 0.8);
            color: white;
        }

        .auth-btn.secondary:hover {
            background: rgba(231, 76, 60, 1);
            transform: translateY(-2px);
        }

        .auth-info {
            text-align: center;
            margin-top: 20px;
        }

        .auth-info small {
            opacity: 0.8;
            font-size: 12px;
        }

        /* Estilos para el panel de administraci√≥n mejorado */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .admin-session-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 12px;
        }

        .admin-level {
            background: var(--primary-gradient);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .session-timer {
            background: rgba(253, 203, 110, 0.2);
            color: var(--warning-color);
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: 600;
        }

        .logout-btn {
            background: var(--error-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .admin-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .admin-section {
            background: rgba(102, 126, 234, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .admin-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-action-btn {
            display: block;
            width: 100%;
            padding: 12px 15px;
            margin: 8px 0;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .admin-action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .admin-action-btn.danger {
            border-color: var(--error-color);
            color: var(--error-color);
        }

        .admin-action-btn.danger:hover {
            background: var(--error-color);
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .stat-number {
            display: block;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .admin-footer {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .close-panel-btn {
            background: rgba(108, 117, 125, 0.1);
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .close-panel-btn:hover {
            background: rgba(108, 117, 125, 0.2);
            transform: translateY(-1px);
        }

        /* Indicador de estado de sistema */
        .system-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            margin: 2px 0;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
        }

        .status-dot.warning {
            background: var(--warning-color);
        }

        .status-dot.danger {
            background: var(--error-color);
        }

        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .chat-container {
                width: 95vw;
                height: 95vh;
            }
            
            .sidebar {
                width: 250px;
            }
        }

        @media (max-width: 768px) {
            .chat-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
                order: 2;
            }
            
            .main-chat {
                order: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div id="loginContainer" class="login-container">
        <div class="login-header">
            <h2>üçá Grapes Fri Chat</h2>
            <p class="login-subtitle">Conecta con tus amigos</p>
        </div>
        
        <div class="login-form">
            <!-- Campo Apodo -->
            <label class="form-label">üë§ Apodo:</label>
            <input type="text" id="username" class="login-input" placeholder="Ingresa tu apodo..." required>
            
            <!-- Campo Sala -->
            <label class="form-label">üè† Sala:</label>
            <input type="text" id="sala" class="login-input" placeholder="General" value="General" required>
        </div>
        
        <div class="login-buttons">
            <button onclick="loginGuest()" class="login-btn btn-guest">üë§ Entrar como Invitado</button>
            <button onclick="login()" class="login-btn btn-primary">üîê Iniciar Sesi√≥n</button>
            <button onclick="register()" class="login-btn btn-secondary">üìù Registrarse</button>
        </div>
    </div>

    <!-- Chat Principal -->
    <div id="chatContainer" class="chat-container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>üçá Grapes Fri Chat</h2>
                <div class="user-info">
                    <span id="currentUserDisplay">Usuario</span>
                </div>
            </div>
            
            <!-- Canales y Salas -->
            <div class="chat-channels">
                <div class="section-title">üè† Canales</div>
                <div class="channel-tabs" id="channelTabs">
                    <div class="channel-tab active" data-channel="general">
                        <span>üì¢ General</span>
                    </div>
                    <div class="add-channel-btn" onclick="crearNuevoCanal()">
                        + Nueva Sala
                    </div>
                </div>
            </div>
            
            <div class="users-section">
                <div class="section-title">üë• Usuarios Conectados</div>
                <div id="usersList" class="user-list">
                    <!-- Los usuarios se llenar√°n din√°micamente -->
                </div>
                
                <div class="section-title">üìä Estad√≠sticas</div>
                <div class="stats-section">
                    <div class="stat-item">
                        <span>Usuarios Online:</span>
                        <span id="onlineCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Mensajes Hoy:</span>
                        <span id="messageCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Tu Estado:</span>
                        <span id="userStatus">Conectado</span>
                    </div>
                </div>
            </div>
            
            <!-- Lista de Amigos -->
            <div class="friends-section">
                <div class="section-title">üë• Amigos</div>
                <div id="friendsList" class="friends-list">
                    <!-- Los amigos se llenar√°n din√°micamente -->
                </div>
                <button class="add-channel-btn" onclick="agregarAmigo()" style="width: 100%; margin-top: 5px;">
                    + Agregar Amigo
                </button>
            </div>
        </div>
        
        <!-- Chat Principal -->
        <div class="main-chat">
            <div class="chat-header">
                <div class="chat-title">
                    <h1 id="currentChannelTitle">üí¨ Sala General</h1>
                    <div class="chat-subtitle" id="currentChannelSubtitle">Chat p√∫blico para todos los usuarios</div>
                </div>
                
                <div class="header-controls">
                    <!-- Controles de Interfaz -->
                    <div class="interface-controls">
                        <button class="interface-toggle" id="compactToggle" onclick="toggleCompactMode()">üìã Compacto</button>
                        <button class="interface-toggle" onclick="toggle2FA()">üîê 2FA</button>
                        <button class="interface-toggle" onclick="mostrarBots()">ü§ñ Bots</button>
                    </div>
                    
                    <!-- Selector de Temas -->
                    <div class="theme-selector-header">
                        <span class="theme-label">üé® Temas:</span>
                        <button class="theme-btn-header theme-claro active" onclick="cambiarTema('claro')" title="Tema Claro"></button>
                        <button class="theme-btn-header theme-oscuro" onclick="cambiarTema('oscuro')" title="Tema Oscuro"></button>
                        <button class="theme-btn-header theme-gris" onclick="cambiarTema('gris')" title="Tema Gris"></button>
                        <button class="theme-btn-header theme-rosado" onclick="cambiarTema('rosado')" title="Tema Rosado"></button>
                        <button class="theme-btn-header theme-verde" onclick="cambiarTema('verde')" title="Tema Verde"></button>
                    </div>
                    
                    <!-- Controles Existentes -->
                    <button class="control-btn" onclick="comandoAdmin()">üîê Admin</button>
                    <button class="control-btn" onclick="crearEncuesta()">üìä Encuesta</button>
                    <button class="control-btn" onclick="toggleSearch()">üîç Buscar</button>
                    <button class="control-btn" onclick="limpiarChat()">üóëÔ∏è Limpiar</button>
                    <button class="control-btn" onclick="mostrarAyuda()">‚ùì Ayuda</button>
                    <button class="control-btn" onclick="desconectar()">üö™ Salir</button>
                </div>
            </div>
            
            <!-- Panel de B√∫squeda -->
            <div id="searchPanel" class="search-panel hidden">
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="Buscar mensajes... (usuario, mensaje, fecha)" onkeyup="buscarMensajes()">
                    <button class="search-btn" onclick="buscarMensajes()">üîç</button>
                    <button class="search-btn" onclick="limpiarBusqueda()">‚úï</button>
                </div>
                <div id="searchResults" class="search-results"></div>
            </div>
            
            <div id="messages" class="chat-messages">
                <!-- Los mensajes se llenar√°n din√°micamente -->
            </div>
            
            <div class="chat-input-section">
                <!-- Indicador de respuesta -->
                <div id="replyIndicator" class="reply-to-message hidden">
                    <button class="reply-cancel" onclick="cancelarRespuesta()">√ó</button>
                    <div class="reply-to-user" id="replyToUser"></div>
                    <div class="reply-to-text" id="replyToText"></div>
                </div>
                
                <!-- √Årea de carga de archivos -->
                <div id="fileUploadArea" class="file-upload-area hidden">
                    <input type="file" id="fileInput" class="file-input" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt">
                    <div class="upload-text">
                        üìÅ Arrastra archivos aqu√≠ o haz clic para seleccionar
                        <br><small>M√°ximo 10MB por archivo</small>
                    </div>
                    <div id="filePreview" class="file-preview"></div>
                </div>
                
                <div class="chat-input-container">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="Escribe un mensaje... (@ para mencionar, : para emojis, Enter para enviar)" 
                        onkeydown="manejarTeclado(event)"
                        oninput="detectarEscritura(); ajustarAlturaTextarea(this); detectarMenciones(this.value)"
                        rows="1"
                    ></textarea>
                    
                    <div class="input-actions">
                        <button class="action-btn emoji-btn" onclick="toggleEmojiPicker()" title="Emojis">üòä</button>
                        <button class="action-btn" style="background: #17a2b8; color: white;" onclick="toggleFileUpload()" title="Archivos">üìé</button>
                        <button id="voiceBtn" class="action-btn voice-record-btn" onclick="toggleVoiceRecording()" title="Mensaje de voz">
                            üé§
                            <div id="voiceRecordTime" class="voice-record-time hidden">0:00</div>
                        </button>
                        <button class="action-btn send-btn" onclick="enviarMensaje()" title="Enviar mensaje">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estado de Conexi√≥n -->
    <div id="status" class="status connecting">üîÑ Conectando...</div>

    <!-- Indicador de Seguridad -->
    <div id="securityIndicator" class="security-indicator" onclick="mostrarEstadoSeguridad()" title="Estado de seguridad">
        üõ°Ô∏è Seguridad Activa
    </div>

    <script>
        // Variables globales
        let ws = null;
        let currentUser = '';
        let reconnectAttempts = 0;
        let messageCount = 0;
        let connectedUsers = new Set();
        let typingTimeout = null;
        let currentTheme = 'claro';
        let allMessages = []; // Para el sistema de b√∫squeda
        let messageReactions = new Map(); // Para las reacciones: messageId -> {emoji: Set(users)}
        let isSearchOpen = false;
        let replyingTo = null; // Para el sistema de respuestas
        let typingUsers = new Set(); // Usuarios que est√°n escribiendo
        let isTyping = false; // Si el usuario actual est√° escribiendo
        let typingTimer = null; // Timer para detectar cuando se deja de escribir
        
        // Nuevas caracter√≠sticas avanzadas
        let activeChannels = new Map(); // Canales/salas activos
        let currentChannel = 'general'; // Canal actual
        let friendsList = new Set(); // Lista de amigos
        let blockedUsers = new Set(); // Usuarios bloqueados
        let privateChats = new Map(); // Chats privados
        let activePolls = new Map(); // Encuestas activas
        let isCompactMode = false; // Modo compacto
        let encryptionKey = null; // Clave de cifrado
        let is2FAEnabled = false; // 2FA habilitado
        let chatBots = new Map(); // Bots disponibles
        
        // üîê SISTEMA DE SEGURIDAD AVANZADO
        let securityConfig = {
            antiSpam: {
                enabled: true,
                messageLimit: 5, // mensajes por minuto
                suspiciousWords: ['spam', 'bot', 'hack', 'virus', 'scam', 'phishing', 'malware'],
                repeatedMessageThreshold: 3,
                capsLockThreshold: 0.7, // 70% del mensaje en may√∫sculas
                linkThreshold: 3 // m√°ximo 3 enlaces por mensaje
            },
            ipControl: {
                enabled: true,
                whitelist: new Set(['127.0.0.1', '::1']), // IPs permitidas
                blacklist: new Set(), // IPs bloqueadas
                maxConnectionsPerIP: 3
            },
            userLimits: {
                maxConcurrentUsers: 100,
                maxUsernameLength: 20,
                minUsernameLength: 3,
                bannedUsernames: new Set(['admin', 'moderator', 'bot', 'system'])
            },
            intrusionDetection: {
                enabled: true,
                suspiciousActivityThreshold: 10,
                rapidConnectionAttempts: 5,
                timeWindow: 60000 // 1 minuto en ms
            },
            // üõ°Ô∏è NUEVO SISTEMA DE ADMINISTRACI√ìN SEGURO
            adminSystem: {
                enabled: true,
                requireMasterKey: true,
                require2FA: true,
                sessionTimeout: 1800000, // 30 minutos
                maxFailedAttempts: 3,
                lockoutDuration: 900000, // 15 minutos
                adminCodes: {
                    // C√≥digos √∫nicos de administrador (se pueden cambiar)
                    'GRAPE-ADMIN-2025-SECURE': { 
                        usuario: 'IKERD11', 
                        nivel: 'super', 
                        expira: Date.now() + (365 * 24 * 60 * 60 * 1000) // 1 a√±o
                    },
                    'MOD-HELPER-SECURE-2025': { 
                        usuario: 'Moderador1', 
                        nivel: 'moderador', 
                        expira: Date.now() + (90 * 24 * 60 * 60 * 1000) // 90 d√≠as
                    },
                    // üî• NUEVOS C√ìDIGOS DE ADMINISTRADOR
                    'DIAMOND-ADMIN-SECURE-2025': { 
                        usuario: 'AdminAmigo1', 
                        nivel: 'super', 
                        expira: Date.now() + (365 * 24 * 60 * 60 * 1000) // 1 a√±o
                    },
                    'EMERALD-MOD-SECURE-2025': { 
                        usuario: 'ModeradorAmigo', 
                        nivel: 'moderador', 
                        expira: Date.now() + (180 * 24 * 60 * 60 * 1000) // 6 meses
                    },
                    'GOLD-ADMIN-SECURE-2025': { 
                        usuario: 'AdminTemporal', 
                        nivel: 'super', 
                        expira: Date.now() + (30 * 24 * 60 * 60 * 1000) // 30 d√≠as
                    },
                    'SILVER-MOD-SECURE-2025': { 
                        usuario: 'ModeradorNuevo', 
                        nivel: 'moderador', 
                        expira: Date.now() + (60 * 24 * 60 * 60 * 1000) // 60 d√≠as
                    }
                }
            }
        };
        
        // üîê Variables de administraci√≥n segura
        let adminSessions = new Map(); // Sesiones de administrador activas
        let failedAdminAttempts = new Map(); // Intentos fallidos por IP/usuario
        let adminTokens = new Map(); // Tokens de sesi√≥n de administrador
        let currentAdminLevel = null; // Nivel de administrador actual
        
        let auditLogs = []; // üìä Registro de auditor√≠a
        let userMetrics = new Map(); // M√©tricas por usuario
        let connectionAttempts = new Map(); // Intentos de conexi√≥n por IP
        let messageHistory = new Map(); // Historial de mensajes por usuario
        let suspiciousActivity = new Map(); // Actividad sospechosa por usuario
        let themeScheduler = null; // Programador de temas din√°micos
        let moderationBot = null; // Bot de moderaci√≥n
        
        const maxReconnectAttempts = 5;
        const WS_URL = window.location.hostname === 'localhost' 
            ? 'ws://localhost:8765' 
            : 'wss://web-production-4b88.up.railway.app';

        // =========================
        // GESTI√ìN DE CONEXI√ìN WEBSOCKET
        // =========================
        function conectarWebSocket() {
            try {
                actualizarStatus('connecting', 'üîÑ Conectando...');
                
                ws = new WebSocket(WS_URL);
                
                ws.onopen = function() {
                    console.log('‚úÖ Conectado al servidor WebSocket');
                    actualizarStatus('online', '‚úÖ Conectado');
                    reconnectAttempts = 0;
                    
                    // Enviar datos del usuario al conectar
                    if (currentUser) {
                        enviarAlServidor({
                            tipo: 'user_connected',
                            usuario: currentUser
                        });
                    }
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        manejarMensaje(data);
                    } catch (error) {
                        console.error('Error al parsear mensaje:', error);
                    }
                };
                
                ws.onclose = function(event) {
                    console.log('‚ùå Conexi√≥n WebSocket cerrada:', event.code);
                    actualizarStatus('offline', '‚ùå Desconectado');
                    
                    // Intentar reconectar autom√°ticamente
                    if (reconnectAttempts < maxReconnectAttempts) {
                        setTimeout(() => {
                            reconnectAttempts++;
                            console.log(`üîÑ Reintento de conexi√≥n ${reconnectAttempts}/${maxReconnectAttempts}`);
                            conectarWebSocket();
                        }, 3000);
                    } else {
                        mostrarNotificacion('‚ùå No se pudo reconectar al servidor', 'error');
                    }
                };
                
                ws.onerror = function(error) {
                    console.error('‚ùå Error de WebSocket:', error);
                    actualizarStatus('offline', '‚ùå Error de conexi√≥n');
                };
                
            } catch (error) {
                console.error('‚ùå Error al conectar WebSocket:', error);
                actualizarStatus('offline', '‚ùå Error de conexi√≥n');
                mostrarNotificacion('‚ùå Error al conectar con el servidor', 'error');
            }
        }

        // =========================
        // GESTI√ìN DE USUARIOS
        // =========================
        function login() {
            const username = document.getElementById('username').value.trim();
            const sala = document.getElementById('sala').value.trim() || 'General';
            
            if (!username) {
                mostrarNotificacion('Por favor ingresa tu apodo', 'error');
                return;
            }
            
            if (username.length < 3) {
                mostrarNotificacion('El apodo debe tener al menos 3 caracteres', 'error');
                return;
            }
            
            // Pedir contrase√±a para login
            const password = prompt('üîê Ingresa tu contrase√±a:');
            if (!password) {
                return;
            }
            
            currentUser = username;
            document.getElementById('currentUserDisplay').textContent = username;
            
            enviarAlServidor({
                tipo: 'login',
                usuario: username,
                password: password,
                sala: sala
            });
        }

        function register() {
            const username = document.getElementById('username').value.trim();
            const sala = document.getElementById('sala').value.trim() || 'General';
            
            if (!username) {
                mostrarNotificacion('Por favor ingresa tu apodo', 'error');
                return;
            }
            
            if (username.length < 3) {
                mostrarNotificacion('El apodo debe tener al menos 3 caracteres', 'error');
                return;
            }
            
            // Pedir contrase√±a para registro
            const password = prompt('üîê Crea una contrase√±a (m√≠nimo 4 caracteres):');
            if (!password) {
                return;
            }
            
            if (password.length < 4) {
                mostrarNotificacion('La contrase√±a debe tener al menos 4 caracteres', 'error');
                return;
            }
            
            // Confirmar contrase√±a
            const confirmPassword = prompt('üîê Confirma tu contrase√±a:');
            if (password !== confirmPassword) {
                mostrarNotificacion('Las contrase√±as no coinciden', 'error');
                return;
            }
            
            currentUser = username;
            document.getElementById('currentUserDisplay').textContent = username;
            
            enviarAlServidor({
                tipo: 'registro',
                usuario: username,
                password: password,
                sala: sala
            });
        }

        function loginGuest() {
            const apodo = document.getElementById('username').value.trim();
            const sala = document.getElementById('sala').value.trim() || 'General';
            
            if (!apodo) {
                mostrarNotificacion('Por favor ingresa tu apodo', 'error');
                return;
            }
            
            if (apodo.length < 3) {
                mostrarNotificacion('El apodo debe tener al menos 3 caracteres', 'error');
                return;
            }
            
            // üîê VALIDACIONES DE SEGURIDAD
            
            // 1. Verificar l√≠mites de usuarios
            const validacionUsuario = verificarLimitesUsuarios(apodo);
            if (!validacionUsuario.permitido) {
                mostrarNotificacion(`üö´ ${validacionUsuario.razon}`, 'error');
                registrarAuditoria('LOGIN_REJECTED', apodo, validacionUsuario.razon);
                return;
            }
            
            // 2. Verificar control de IP (simulado para frontend)
            const ipSimulada = '127.0.0.1'; // En producci√≥n ser√≠a la IP real
            const validacionIP = verificarControlIP(ipSimulada);
            if (!validacionIP.permitido) {
                mostrarNotificacion(`üö´ ${validacionIP.razon}`, 'error');
                return;
            }
            
            // 3. Detectar actividad de conexi√≥n
            detectarActividadSospechosa(apodo, 'CONEXION', 'Login como invitado');
            
            // Usar el apodo ingresado por el usuario
            currentUser = apodo;
            document.getElementById('currentUserDisplay').textContent = apodo;
            
            enviarAlServidor({
                tipo: 'invitado',
                usuario: apodo,
                sala: sala
            });
            
            // Para modo invitado, mostrar chat inmediatamente
            mostrarChat();
            mostrarMensajeSistema(`¬°Bienvenido al chat, ${apodo}! Te has conectado como invitado en la sala "${sala}".`);
            
            // Actualizar estad√≠sticas inmediatamente
            actualizarEstadisticas();
            
            // Inicializar sistemas de seguridad
            inicializarSistemasSeguridad();
            
            // Registrar en auditor√≠a
            registrarAuditoria('GUEST_LOGIN_SUCCESS', apodo, `Sala: ${sala}`);
        }

        // =========================
        // GESTI√ìN DE MENSAJES
        // =========================
        function enviarMensaje() {
            const input = document.getElementById('messageInput');
            const mensaje = input.value.trim();
            
            if (!mensaje) return;
            
            // Verificar si es un comando de bot
            if (procesarComandoBot(mensaje)) {
                input.value = '';
                return;
            }
            
            if (mensaje.length > 500) {
                mostrarNotificacion('El mensaje es demasiado largo (m√°ximo 500 caracteres)', 'error');
                return;
            }
            
            // üîê VALIDACIONES DE SEGURIDAD
            
            // 1. Verificar anti-spam
            const analisisSpam = analizarAntiSpam(currentUser, mensaje);
            if (!analisisSpam.permitido) {
                mostrarNotificacion(`üö´ Mensaje bloqueado: ${analisisSpam.razon}`, 'error');
                detectarActividadSospechosa(currentUser, 'SPAM_ATTEMPT', analisisSpam.razon);
                return;
            }
            
            // 2. Censurar mensaje si es necesario
            const resultadoCensura = censurarMensaje(currentUser, mensaje);
            const mensajeEnviar = resultadoCensura.mensajeLimpio;
            
            // 3. Detectar actividad sospechosa
            detectarActividadSospechosa(currentUser, 'MESSAGE_SENT', `Longitud: ${mensaje.length}`);
            
            // Detener indicador de escritura al enviar mensaje
            if (isTyping) {
                isTyping = false;
                if (typingTimer) {
                    clearTimeout(typingTimer);
                }
                enviarAlServidor({
                    tipo: 'typing_stop',
                    usuario: currentUser
                });
            }
            
            const mensajeData = {
                tipo: 'mensaje',
                usuario: currentUser,
                mensaje: mensajeEnviar, // Usar mensaje censurado
                sala: 'General',
                timestamp: new Date().toISOString()
            };
            
            // Agregar informaci√≥n de respuesta si existe
            if (replyingTo) {
                mensajeData.replyTo = replyingTo;
                cancelarRespuesta();
            }
            
            enviarAlServidor(mensajeData);
            
            input.value = '';
            ajustarAlturaTextarea(input);
            messageCount++;
            actualizarEstadisticas();
            
            // Registrar en auditor√≠a
            registrarAuditoria('MESSAGE_SENT', currentUser, `Mensaje enviado (${mensajeEnviar.length} chars)`);
        }

        function manejarTeclado(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                enviarMensaje();
                return;
            }
            
            // Auto-resize del textarea
            ajustarAlturaTextarea(event.target);
            
            // Detectar escritura para el indicador
            detectarEscritura();
        }

        function detectarEscritura() {
            // Si no estaba escribiendo antes, notificar que empez√≥ a escribir
            if (!isTyping) {
                isTyping = true;
                enviarAlServidor({
                    tipo: 'typing_start',
                    usuario: currentUser
                });
            }
            
            // Limpiar el timer anterior
            if (typingTimer) {
                clearTimeout(typingTimer);
            }
            
            // Establecer nuevo timer para detectar cuando se deja de escribir
            typingTimer = setTimeout(() => {
                if (isTyping) {
                    isTyping = false;
                    enviarAlServidor({
                        tipo: 'typing_stop',
                        usuario: currentUser
                    });
                }
            }, 1500); // 1.5 segundos sin escribir = se dej√≥ de escribir
        }

        function ajustarAlturaTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        function enviarAlServidor(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(data));
            } else {
                console.log('‚ùå No hay conexi√≥n al servidor. Datos:', data);
                mostrarNotificacion('No hay conexi√≥n al servidor', 'error');
            }
        }

        function manejarMensaje(data) {
            switch(data.tipo) {
                case 'login_exitoso':
                    mostrarChat();
                    mostrarMensajeSistema(`¬°Bienvenido de vuelta, ${currentUser}!`);
                    actualizarEstadisticas();
                    break;
                    
                case 'registro_exitoso':
                    mostrarNotificacion('¬°Registro exitoso! Bienvenido al chat', 'success');
                    mostrarChat();
                    mostrarMensajeSistema(`¬°Bienvenido por primera vez, ${currentUser}!`);
                    actualizarEstadisticas();
                    break;
                    
                case 'error':
                    mostrarNotificacion('Error: ' + data.mensaje, 'error');
                    break;
                    
                case 'mensaje':
                    mostrarMensajeEnChat(data.usuario, data.mensaje, data.usuario === currentUser, data.timestamp, data.replyTo);
                    break;
                    
                case 'reaccion':
                    manejarReaccionRecibida(data);
                    break;
                    
                case 'typing_start':
                    if (data.usuario !== currentUser) {
                        typingUsers.add(data.usuario);
                        actualizarIndicadorEscritura();
                    }
                    break;
                    
                case 'typing_stop':
                    if (data.usuario !== currentUser) {
                        typingUsers.delete(data.usuario);
                        actualizarIndicadorEscritura();
                    }
                    break;
                    
                case 'user_connected':
                    connectedUsers.add(data.usuario);
                    actualizarListaUsuarios();
                    mostrarMensajeSistema(`${data.usuario} se ha conectado al chat`);
                    break;
                    
                case 'user_disconnected':
                    connectedUsers.delete(data.usuario);
                    actualizarListaUsuarios();
                    mostrarMensajeSistema(`${data.usuario} se ha desconectado del chat`);
                    break;
                    
                case 'usuarios_conectados':
                    if (data.usuarios) {
                        connectedUsers.clear();
                        data.usuarios.forEach(user => connectedUsers.add(user));
                        actualizarListaUsuarios();
                    }
                    break;
                    
                default:
                    console.log('Tipo de mensaje no reconocido:', data.tipo);
                    break;
            }
        }

        // üîê SISTEMA DE SEGURIDAD Y ANTI-SPAM AVANZADO
        // =========================
        
        // üö´ Anti-spam inteligente con ML b√°sico
        function analizarAntiSpam(usuario, mensaje) {
            if (!securityConfig.antiSpam.enabled) return { permitido: true, razon: '' };
            
            const analisis = {
                permitido: true,
                razon: '',
                puntuacionSospechosa: 0
            };
            
            // 1. Verificar l√≠mite de mensajes por minuto
            if (!messageHistory.has(usuario)) {
                messageHistory.set(usuario, []);
            }
            
            const ahora = Date.now();
            const historial = messageHistory.get(usuario);
            
            // Limpiar mensajes antiguos (m√°s de 1 minuto)
            const mensajesRecientes = historial.filter(tiempo => ahora - tiempo < 60000);
            messageHistory.set(usuario, mensajesRecientes);
            
            if (mensajesRecientes.length >= securityConfig.antiSpam.messageLimit) {
                analisis.permitido = false;
                analisis.razon = 'L√≠mite de mensajes por minuto excedido';
                registrarAuditoria('SPAM_DETECTED', usuario, `L√≠mite de mensajes: ${mensajesRecientes.length}/min`);
                return analisis;
            }
            
            // 2. Detectar palabras sospechosas
            const palabrasEncontradas = securityConfig.antiSpam.suspiciousWords.filter(palabra => 
                mensaje.toLowerCase().includes(palabra.toLowerCase())
            );
            
            if (palabrasEncontradas.length > 0) {
                analisis.puntuacionSospechosa += palabrasEncontradas.length * 2;
                registrarAuditoria('SUSPICIOUS_WORDS', usuario, `Palabras: ${palabrasEncontradas.join(', ')}`);
            }
            
            // 3. Detectar mensajes repetidos
            const ultimosMensajes = historial.slice(-securityConfig.antiSpam.repeatedMessageThreshold);
            const mensajesIguales = ultimosMensajes.filter(msg => msg.texto === mensaje).length;
            
            if (mensajesIguales >= securityConfig.antiSpam.repeatedMessageThreshold) {
                analisis.permitido = false;
                analisis.razon = 'Mensaje repetido detectado';
                registrarAuditoria('REPEATED_MESSAGE', usuario, `Mensaje repetido ${mensajesIguales} veces`);
                return analisis;
            }
            
            // 4. Detectar abuso de may√∫sculas
            const mayusculas = (mensaje.match(/[A-Z]/g) || []).length;
            const porcentajeMayusculas = mayusculas / mensaje.length;
            
            if (porcentajeMayusculas > securityConfig.antiSpam.capsLockThreshold && mensaje.length > 10) {
                analisis.puntuacionSospechosa += 3;
                registrarAuditoria('CAPS_ABUSE', usuario, `${Math.round(porcentajeMayusculas * 100)}% may√∫sculas`);
            }
            
            // 5. Detectar enlaces excesivos
            const enlaces = (mensaje.match(/https?:\/\/[^\s]+/g) || []).length;
            if (enlaces > securityConfig.antiSpam.linkThreshold) {
                analisis.permitido = false;
                analisis.razon = 'Demasiados enlaces en el mensaje';
                registrarAuditoria('EXCESSIVE_LINKS', usuario, `${enlaces} enlaces detectados`);
                return analisis;
            }
            
            // 6. Puntuaci√≥n general de sospecha
            if (analisis.puntuacionSospechosa >= 5) {
                analisis.permitido = false;
                analisis.razon = 'Contenido sospechoso detectado por IA';
                registrarAuditoria('AI_SPAM_DETECTION', usuario, `Puntuaci√≥n: ${analisis.puntuacionSospechosa}`);
            }
            
            // Registrar mensaje v√°lido
            mensajesRecientes.push({ tiempo: ahora, texto: mensaje });
            messageHistory.set(usuario, mensajesRecientes);
            
            return analisis;
        }
        
        // üö™ Control de acceso por IP
        function verificarControlIP(ip) {
            if (!securityConfig.ipControl.enabled) return { permitido: true, razon: '' };
            
            // Verificar blacklist
            if (securityConfig.ipControl.blacklist.has(ip)) {
                registrarAuditoria('IP_BLOCKED', 'Sistema', `IP bloqueada: ${ip}`);
                return { permitido: false, razon: 'IP bloqueada por el administrador' };
            }
            
            // Verificar whitelist (si no est√° vac√≠a)
            if (securityConfig.ipControl.whitelist.size > 0 && !securityConfig.ipControl.whitelist.has(ip)) {
                registrarAuditoria('IP_NOT_WHITELISTED', 'Sistema', `IP no autorizada: ${ip}`);
                return { permitido: false, razon: 'IP no autorizada' };
            }
            
            // Verificar l√≠mite de conexiones por IP
            if (!connectionAttempts.has(ip)) {
                connectionAttempts.set(ip, { count: 0, lastAttempt: Date.now() });
            }
            
            const conexiones = connectionAttempts.get(ip);
            if (conexiones.count >= securityConfig.ipControl.maxConnectionsPerIP) {
                registrarAuditoria('IP_CONNECTION_LIMIT', 'Sistema', `L√≠mite de conexiones excedido: ${ip}`);
                return { permitido: false, razon: 'Demasiadas conexiones desde esta IP' };
            }
            
            conexiones.count++;
            conexiones.lastAttempt = Date.now();
            connectionAttempts.set(ip, conexiones);
            
            return { permitido: true, razon: '' };
        }
        
        // üë• Control de l√≠mites de usuarios
        function verificarLimitesUsuarios(usuario) {
            const limites = securityConfig.userLimits;
            
            // Verificar longitud del nombre de usuario
            if (usuario.length < limites.minUsernameLength || usuario.length > limites.maxUsernameLength) {
                return { 
                    permitido: false, 
                    razon: `El nombre debe tener entre ${limites.minUsernameLength} y ${limites.maxUsernameLength} caracteres` 
                };
            }
            
            // Verificar nombres prohibidos
            if (limites.bannedUsernames.has(usuario.toLowerCase())) {
                registrarAuditoria('BANNED_USERNAME', usuario, 'Intento de usar nombre prohibido');
                return { permitido: false, razon: 'Nombre de usuario no permitido' };
            }
            
            // Verificar l√≠mite de usuarios concurrentes
            if (connectedUsers.size >= limites.maxConcurrentUsers) {
                registrarAuditoria('USER_LIMIT_REACHED', usuario, `L√≠mite alcanzado: ${connectedUsers.size}/${limites.maxConcurrentUsers}`);
                return { permitido: false, razon: 'L√≠mite de usuarios conectados alcanzado' };
            }
            
            return { permitido: true, razon: '' };
        }
        
        // üëÅÔ∏è Sistema de detecci√≥n de intrusos
        function detectarActividadSospechosa(usuario, accion, detalle = '') {
            if (!securityConfig.intrusionDetection.enabled) return;
            
            if (!suspiciousActivity.has(usuario)) {
                suspiciousActivity.set(usuario, {
                    eventos: [],
                    puntuacion: 0,
                    ultimaActividad: Date.now()
                });
            }
            
            const actividad = suspiciousActivity.get(usuario);
            const ahora = Date.now();
            
            // Limpiar eventos antiguos
            actividad.eventos = actividad.eventos.filter(evento => 
                ahora - evento.timestamp < securityConfig.intrusionDetection.timeWindow
            );
            
            // Agregar nuevo evento
            actividad.eventos.push({
                accion: accion,
                detalle: detalle,
                timestamp: ahora
            });
            
            // Calcular puntuaci√≥n de sospecha
            let puntuacion = 0;
            const eventosRecientes = actividad.eventos.length;
            
            if (eventosRecientes > securityConfig.intrusionDetection.suspiciousActivityThreshold) {
                puntuacion += eventosRecientes * 2;
            }
            
            // Detectar conexiones r√°pidas
            const conexionesRapidas = actividad.eventos.filter(e => e.accion === 'CONEXION').length;
            if (conexionesRapidas > securityConfig.intrusionDetection.rapidConnectionAttempts) {
                puntuacion += conexionesRapidas * 3;
                registrarAuditoria('RAPID_CONNECTIONS', usuario, `${conexionesRapidas} conexiones r√°pidas`);
            }
            
            actividad.puntuacion = puntuacion;
            actividad.ultimaActividad = ahora;
            
            // Alertar si la actividad es muy sospechosa
            if (puntuacion > 20) {
                mostrarAlertaIntrusion(usuario, puntuacion, actividad.eventos);
                registrarAuditoria('INTRUSION_ALERT', usuario, `Puntuaci√≥n de sospecha: ${puntuacion}`);
            }
            
            suspiciousActivity.set(usuario, actividad);
        }
        
        // üìä Sistema de audit logs
        function registrarAuditoria(evento, usuario, detalle = '') {
            const registro = {
                timestamp: new Date().toISOString(),
                evento: evento,
                usuario: usuario,
                detalle: detalle,
                ip: 'N/A', // En un entorno real, obtendr√≠amos la IP
                userAgent: navigator.userAgent
            };
            
            auditLogs.push(registro);
            
            // Mantener solo los √∫ltimos 1000 registros
            if (auditLogs.length > 1000) {
                auditLogs = auditLogs.slice(-1000);
            }
            
            console.log(`üîç [AUDIT] ${evento}: ${usuario} - ${detalle}`);
            
            // Mostrar en interfaz si es cr√≠tico
            if (['INTRUSION_ALERT', 'IP_BLOCKED', 'SPAM_DETECTED'].includes(evento)) {
                mostrarNotificacion(`üö® Alerta de seguridad: ${evento}`, 'warning');
            }
        }
        
        // üåà Sistema de temas din√°micos
        function inicializarTemasDinamicos() {
            // Programar cambios de tema seg√∫n la hora
            themeScheduler = setInterval(() => {
                const hora = new Date().getHours();
                let temaAutomatico = '';
                
                if (hora >= 6 && hora < 12) {
                    temaAutomatico = 'claro'; // Ma√±ana
                } else if (hora >= 12 && hora < 18) {
                    temaAutomatico = 'verde'; // Tarde
                } else if (hora >= 18 && hora < 22) {
                    temaAutomatico = 'rosado'; // Atardecer
                } else {
                    temaAutomatico = 'oscuro'; // Noche
                }
                
                if (currentTheme !== temaAutomatico) {
                    cambiarTema(temaAutomatico);
                    mostrarNotificacion(`üåà Tema cambiado autom√°ticamente a ${temaAutomatico} seg√∫n la hora`, 'info');
                    registrarAuditoria('THEME_AUTO_CHANGE', currentUser, `Tema: ${temaAutomatico}, Hora: ${hora}:00`);
                }
            }, 60000); // Verificar cada minuto
        }
        
        // ü§ñ Bot de moderaci√≥n y censura
        function inicializarBotModeracion() {
            moderationBot = {
                nombre: 'ModeradorBot',
                palabrasProhibidas: [
                    'idiota', 'est√∫pido', 'tonto', 'imb√©cil',
                    'odio', 'matar', 'morir', 'suicidio',
                    'drogas', 'alcohol', 'cerveza',
                    'sexo', 'porno', 'xxx',
                    'hack', 'hackear', 'piratear'
                ],
                advertencias: new Map(),
                accionesDisciplinarias: ['advertencia', 'silencio_temporal', 'expulsion']
            };
            
            chatBots.set('moderador', moderationBot);
            registrarAuditoria('BOT_INITIALIZED', 'Sistema', 'Bot de moderaci√≥n activado');
        }
        
        function censurarMensaje(usuario, mensaje) {
            if (!moderationBot) return { censurado: false, mensajeLimpio: mensaje };
            
            let mensajeLimpio = mensaje;
            let palabrasEncontradas = [];
            
            // Verificar palabras prohibidas
            moderationBot.palabrasProhibidas.forEach(palabra => {
                const regex = new RegExp(`\\b${palabra}\\b`, 'gi');
                if (regex.test(mensajeLimpio)) {
                    palabrasEncontradas.push(palabra);
                    mensajeLimpio = mensajeLimpio.replace(regex, '***');
                }
            });
            
            if (palabrasEncontradas.length > 0) {
                // Registrar advertencia
                if (!moderationBot.advertencias.has(usuario)) {
                    moderationBot.advertencias.set(usuario, 0);
                }
                
                const advertencias = moderationBot.advertencias.get(usuario) + 1;
                moderationBot.advertencias.set(usuario, advertencias);
                
                registrarAuditoria('MESSAGE_CENSORED', usuario, `Palabras censuradas: ${palabrasEncontradas.join(', ')}`);
                
                // Enviar advertencia privada
                setTimeout(() => {
                    mostrarMensajeBot(
                        'ModeradorBot',
                        `‚ö†Ô∏è ${usuario}, tu mensaje fue censurado por contener lenguaje inapropiado. Advertencias: ${advertencias}/3`,
                        'warning'
                    );
                    
                    // Acci√≥n disciplinaria si tiene muchas advertencias
                    if (advertencias >= 3) {
                        aplicarAccionDisciplinaria(usuario, advertencias);
                    }
                }, 500);
                
                return { censurado: true, mensajeLimpio: mensajeLimpio };
            }
            
            return { censurado: false, mensajeLimpio: mensaje };
        }
        
        function aplicarAccionDisciplinaria(usuario, advertencias) {
            let accion = '';
            
            if (advertencias >= 5) {
                accion = 'expulsion';
                mostrarMensajeBot('ModeradorBot', `üö´ ${usuario} ha sido expulsado del chat por violaciones repetidas.`, 'error');
                registrarAuditoria('USER_EXPELLED', usuario, `${advertencias} advertencias acumuladas`);
                // En un entorno real, desconectar√≠amos al usuario
            } else if (advertencias >= 4) {
                accion = 'silencio_temporal';
                mostrarMensajeBot('ModeradorBot', `üîá ${usuario} ha sido silenciado temporalmente (5 minutos).`, 'warning');
                registrarAuditoria('USER_MUTED', usuario, `Silenciado por ${advertencias} advertencias`);
            } else {
                accion = 'advertencia';
                mostrarMensajeBot('ModeradorBot', `‚ö†Ô∏è √öltima advertencia para ${usuario}. Pr√≥xima violaci√≥n resultar√° en silencio temporal.`, 'warning');
            }
        }
        
        function mostrarMensajeBot(botNombre, mensaje, tipo = 'info') {
            const botMessage = document.createElement('div');
            botMessage.className = 'message bot-message';
            
            const tipoIcon = {
                'info': '‚ÑπÔ∏è',
                'warning': '‚ö†Ô∏è',
                'error': 'üö´',
                'success': '‚úÖ'
            };
            
            botMessage.innerHTML = `
                <div class="message-avatar bot-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="message-header">
                        <div class="message-user-info">
                            <strong class="message-username">${botNombre}</strong>
                            <span class="bot-indicator">BOT</span>
                        </div>
                        <span class="message-time">${formatearHora(new Date())}</span>
                    </div>
                    <div class="message-text">${tipoIcon[tipo]} ${mensaje}</div>
                </div>
            `;
            
            document.getElementById('messages').appendChild(botMessage);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }
        
        function mostrarAlertaIntrusion(usuario, puntuacion, eventos) {
            const alertaDiv = document.createElement('div');
            alertaDiv.className = 'intrusion-alert';
            alertaDiv.innerHTML = `
                <div class="alert-header">üö® ALERTA DE SEGURIDAD</div>
                <div class="alert-content">
                    <strong>Usuario:</strong> ${usuario}<br>
                    <strong>Puntuaci√≥n de riesgo:</strong> ${puntuacion}<br>
                    <strong>Eventos sospechosos:</strong> ${eventos.length}<br>
                    <strong>√öltima actividad:</strong> ${eventos[eventos.length - 1]?.accion}
                </div>
                <button onclick="this.parentElement.remove()">Cerrar</button>
            `;
            
            document.body.appendChild(alertaDiv);
            
            // Auto-eliminar despu√©s de 10 segundos
            setTimeout(() => {
                if (alertaDiv.parentElement) {
                    alertaDiv.remove();
                }
            }, 10000);
        }

        function mostrarMensajeEnChat(usuario, mensaje, esMio, timestamp = null, replyTo = null) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            messageDiv.className = `message ${esMio ? 'sent' : 'received'}`;
            messageDiv.setAttribute('data-message-id', messageId);
            
            // Guardar mensaje para b√∫squeda
            allMessages.push({
                id: messageId,
                usuario: usuario,
                mensaje: mensaje,
                timestamp: timestamp || new Date().toISOString(),
                esMio: esMio,
                replyTo: replyTo
            });
            
            // Funci√≥n para obtener rol del usuario (VERSI√ìN SEGURA)
            function obtenerRolUsuario(username) {
                // Verificar si tiene sesi√≥n de administrador activa
                if (esAdministrador('super') && username === currentUser) {
                    return { rol: 'Super Admin', color: '#e74c3c' };
                } else if (esAdministrador('moderador') && username === currentUser) {
                    return { rol: 'Admin', color: '#e67e22' };
                } else if (username.toLowerCase().includes('mod') || username.toLowerCase().includes('moderador')) {
                    return { rol: 'Moderador', color: '#f39c12' };
                } else if (username.toLowerCase().includes('guest') || username.toLowerCase().includes('invitado')) {
                    return { rol: 'Invitado', color: '#95a5a6' };
                } else {
                    return { rol: 'Usuario', color: '#3498db' };
                }
            }
            
            // Crear avatar con inicial del usuario
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.textContent = usuario.charAt(0).toUpperCase();
            
            // Crear contenido del mensaje
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.style.position = 'relative';
            
            // Botones de reacci√≥n r√°pida y respuesta (solo para mensajes recibidos)
            if (!esMio) {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                
                // Bot√≥n de respuesta
                const replyBtn = document.createElement('button');
                replyBtn.className = 'quick-reaction';
                replyBtn.textContent = '‚Ü©Ô∏è';
                replyBtn.title = 'Responder mensaje';
                replyBtn.onclick = () => responderMensaje(messageId, usuario, mensaje);
                actionsDiv.appendChild(replyBtn);
                
                const quickReactions = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üò°'];
                quickReactions.forEach(emoji => {
                    const reactionBtn = document.createElement('button');
                    reactionBtn.className = 'quick-reaction';
                    reactionBtn.textContent = emoji;
                    reactionBtn.title = `Reaccionar con ${emoji}`;
                    reactionBtn.onclick = () => agregarReaccion(messageId, emoji);
                    actionsDiv.appendChild(reactionBtn);
                });
                
                contentDiv.appendChild(actionsDiv);
            }
            
            // Mostrar referencia de respuesta si existe
            if (replyTo) {
                const replyRefDiv = document.createElement('div');
                replyRefDiv.className = 'message-reply-reference';
                replyRefDiv.onclick = () => scrollToMessage(replyTo.messageId);
                replyRefDiv.innerHTML = `
                    <div class="reply-reference-user">‚Ü©Ô∏è ${replyTo.usuario}</div>
                    <div class="reply-reference-text">${replyTo.mensaje.length > 50 ? replyTo.mensaje.substring(0, 50) + '...' : replyTo.mensaje}</div>
                `;
                contentDiv.appendChild(replyRefDiv);
            }
            
            if (!esMio) {
                const headerDiv = document.createElement('div');
                headerDiv.className = 'message-header';
                
                const userInfoDiv = document.createElement('div');
                userInfoDiv.className = 'message-user-info';
                
                const usernameSpan = document.createElement('span');
                usernameSpan.className = 'message-username';
                usernameSpan.textContent = usuario;
                
                const userRole = obtenerRolUsuario(usuario);
                const roleSpan = document.createElement('span');
                roleSpan.className = 'message-user-role';
                roleSpan.style.backgroundColor = userRole.color;
                roleSpan.textContent = userRole.rol;
                
                const timeSpan = document.createElement('div');
                timeSpan.className = 'message-time';
                // Asegurar que el timestamp sea v√°lido antes de formatearlo
                const timeText = formatearTiempo(timestamp || new Date().toISOString());
                timeSpan.textContent = timeText;
                
                userInfoDiv.appendChild(usernameSpan);
                userInfoDiv.appendChild(roleSpan);
                headerDiv.appendChild(userInfoDiv);
                headerDiv.appendChild(timeSpan);
                contentDiv.appendChild(headerDiv);
            }
            
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = mensaje;
            contentDiv.appendChild(textDiv);
            
            // Contenedor para reacciones
            const reactionsDiv = document.createElement('div');
            reactionsDiv.className = 'message-reactions';
            reactionsDiv.id = `reactions_${messageId}`;
            contentDiv.appendChild(reactionsDiv);
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Efecto de aparici√≥n
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translateY(20px)';
            setTimeout(() => {
                messageDiv.style.transition = 'all 0.3s ease';
                messageDiv.style.opacity = '1';
                messageDiv.style.transform = 'translateY(0)';
            }, 50);
        }

        function mostrarMensajeSistema(mensaje) {
            const messagesDiv = document.getElementById('messages');
            const systemDiv = document.createElement('div');
            systemDiv.className = 'typing-indicator';
            systemDiv.innerHTML = `ü§ñ <strong>Sistema:</strong> ${mensaje}`;
            messagesDiv.appendChild(systemDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            setTimeout(() => {
                systemDiv.style.opacity = '0';
                systemDiv.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    if (systemDiv.parentNode) {
                        systemDiv.parentNode.removeChild(systemDiv);
                    }
                }, 300);
            }, 5000);
        }

        // =========================
        // GESTI√ìN DE INTERFAZ
        // =========================
        function mostrarChat() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('chatContainer').classList.remove('hidden');
            
            // Actualizar la lista de usuarios y estad√≠sticas
            actualizarListaUsuarios();
            
            // Enfocar en el input de mensajes
            setTimeout(() => {
                document.getElementById('messageInput').focus();
            }, 300);
        }

        function actualizarListaUsuarios() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            // Funci√≥n para obtener rol del usuario (VERSI√ìN SEGURA)
            function obtenerRolUsuario(username) {
                // üêõ DEBUG: Verificaci√≥n de estado de administrador
                const isAdminSuper = esAdministrador('super');
                const isAdminMod = esAdministrador('moderador');
                const hasAdminSession = adminSessions.has(currentUser);
                
                console.log(`üîç DEBUG ROL USUARIO: ${username}`);
                console.log(`üìä Usuario actual: ${currentUser}`);
                console.log(`üîë Es Super Admin: ${isAdminSuper}`);
                console.log(`üîí Es Moderador: ${isAdminMod}`);
                console.log(`üíº Tiene sesi√≥n admin: ${hasAdminSession}`);
                
                if (hasAdminSession) {
                    const session = adminSessions.get(currentUser);
                    console.log(`‚è∞ Sesi√≥n expira en: ${Math.round((session.expira - Date.now()) / 1000 / 60)} minutos`);
                    console.log(`üìã Nivel de sesi√≥n: ${session.nivel}`);
                }
                
                // Verificar si tiene sesi√≥n de administrador activa
                if (esAdministrador('super') && username === currentUser) {
                    console.log(`‚úÖ Asignando rol: Super Admin`);
                    return { rol: 'Super Admin', color: '#e74c3c' };
                } else if (esAdministrador('moderador') && username === currentUser) {
                    console.log(`‚úÖ Asignando rol: Admin`);
                    return { rol: 'Admin', color: '#e67e22' };
                } else if (username.toLowerCase().includes('mod') || username.toLowerCase().includes('moderador')) {
                    console.log(`‚úÖ Asignando rol: Moderador (por nombre)`);
                    return { rol: 'Moderador', color: '#f39c12' };
                } else if (username.toLowerCase().includes('guest') || username.toLowerCase().includes('invitado')) {
                    console.log(`‚úÖ Asignando rol: Invitado`);
                    return { rol: 'Invitado', color: '#95a5a6' };
                } else {
                    console.log(`‚úÖ Asignando rol: Usuario`);
                    return { rol: 'Usuario', color: '#3498db' };
                }
            }
            
            // Agregar usuario actual primero
            const currentUserItem = document.createElement('div');
            currentUserItem.className = 'user-item';
            const currentUserRole = obtenerRolUsuario(currentUser);
            currentUserItem.innerHTML = `
                <div class="user-status"></div>
                <div class="user-info">
                    <div class="user-name">${currentUser}</div>
                    <div class="user-role" style="background-color: ${currentUserRole.color}">${currentUserRole.rol}</div>
                    <div class="user-label">(T√∫)</div>
                </div>
            `;
            usersList.appendChild(currentUserItem);
            
            // Agregar otros usuarios conectados
            connectedUsers.forEach(username => {
                if (username !== currentUser) {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    const userRole = obtenerRolUsuario(username);
                    userItem.innerHTML = `
                        <div class="user-status"></div>
                        <div class="user-info">
                            <div class="user-name">${username}</div>
                            <div class="user-role" style="background-color: ${userRole.color}">${userRole.rol}</div>
                        </div>
                    `;
                    usersList.appendChild(userItem);
                }
            });
            
            actualizarEstadisticas();
        }

        function actualizarEstadisticas() {
            // Contar todos los usuarios conectados incluyendo el usuario actual
            const totalUsuarios = connectedUsers.size + (currentUser ? 1 : 0);
            
            const onlineCountElement = document.getElementById('onlineCount');
            if (onlineCountElement) {
                onlineCountElement.textContent = totalUsuarios;
            }
            
            const messageCountElement = document.getElementById('messageCount');
            if (messageCountElement) {
                messageCountElement.textContent = messageCount;
            }
        }

        function cambiarTema(tema) {
            // Remover clase active de todos los botones (tanto antiguos como nuevos)
            document.querySelectorAll('.theme-btn, .theme-btn-header').forEach(btn => btn.classList.remove('active'));
            
            // Agregar clase active al bot√≥n seleccionado (buscar en ambas clases)
            const botonTema = document.querySelector(`.theme-${tema}`) || document.querySelector(`.theme-btn-header.theme-${tema}`);
            if (botonTema) {
                botonTema.classList.add('active');
            }
            
            const root = document.documentElement;
            currentTheme = tema;
            
            switch(tema) {
                case 'claro':
                    root.style.setProperty('--primary-gradient', 'linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)');
                    root.style.setProperty('--primary-color', '#74b9ff');
                    break;
                case 'oscuro':
                    root.style.setProperty('--primary-gradient', 'linear-gradient(135deg, #2d3436 0%, #636e72 100%)');
                    root.style.setProperty('--primary-color', '#2d3436');
                    break;
                case 'gris':
                    root.style.setProperty('--primary-gradient', 'linear-gradient(135deg, #b2bec3 0%, #74b9ff 100%)');
                    root.style.setProperty('--primary-color', '#b2bec3');
                    break;
                case 'rosado':
                    root.style.setProperty('--primary-gradient', 'linear-gradient(135deg, #fd79a8 0%, #e84393 100%)');
                    root.style.setProperty('--primary-color', '#fd79a8');
                    break;
                case 'verde':
                    root.style.setProperty('--primary-gradient', 'linear-gradient(135deg, #00b894 0%, #00cec9 100%)');
                    root.style.setProperty('--primary-color', '#00b894');
                    break;
            }
            
            mostrarNotificacion(`Tema cambiado a: ${tema.charAt(0).toUpperCase() + tema.slice(1)}`, 'success');
        }

        // =========================
        // UTILIDADES
        // =========================
        function actualizarStatus(tipo, mensaje) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = mensaje;
            statusElement.className = `status ${tipo}`;
            
            // Actualizar estado en la sidebar
            const userStatusElement = document.getElementById('userStatus');
            if (userStatusElement) {
                if (tipo === 'online') {
                    userStatusElement.textContent = 'Conectado';
                } else if (tipo === 'offline') {
                    userStatusElement.textContent = 'Desconectado';
                } else {
                    userStatusElement.textContent = 'Conectando...';
                }
            }
        }

        function mostrarNotificacion(mensaje, tipo = 'success') {
            // Remover notificaci√≥n anterior si existe
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.borderLeftColor = tipo === 'success' ? 'var(--success-color)' : 'var(--error-color)';
            notification.innerHTML = `
                <strong>${tipo === 'success' ? '‚úÖ' : '‚ùå'}</strong> ${mensaje}
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remover despu√©s de 4 segundos
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        function formatearTiempo(timestamp) {
            // Si no hay timestamp, devolver hora actual
            if (!timestamp) {
                return new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            }
            
            try {
                const fecha = new Date(timestamp);
                
                // Verificar si la fecha es v√°lida
                if (isNaN(fecha.getTime())) {
                    // Si el timestamp es inv√°lido, devolver hora actual
                    return new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                }
                
                return fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            } catch (error) {
                // En caso de error, devolver hora actual
                console.error('Error al formatear tiempo:', error);
                return new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            }
        }
        
        function formatearHora(fecha) {
            return fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        }

        function limpiarChat() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar el chat?')) {
                document.getElementById('messages').innerHTML = '';
                allMessages = [];
                messageReactions.clear();
                typingUsers.clear(); // Limpiar usuarios escribiendo
                cancelarRespuesta();
                mostrarMensajeSistema('Chat limpiado por ' + currentUser);
            }
        }

        function mostrarAyuda() {
            const ayuda = `
üçá AYUDA DE GRAPES FRI CHAT

üìù COMANDOS B√ÅSICOS:
‚Ä¢ Enter: Enviar mensaje
‚Ä¢ Shift + Enter: Nueva l√≠nea
‚Ä¢ /clear: Limpiar chat

üé® TEMAS DISPONIBLES:
‚Ä¢ Claro: Azul cl√°sico
‚Ä¢ Oscuro: Estilo nocturno
‚Ä¢ Gris: Minimalista
‚Ä¢ Rosado: Vibrante
‚Ä¢ Verde: Natural

‚ú® NUEVAS CARACTER√çSTICAS:
‚Ä¢ ÔøΩ Reacciones: Haz hover sobre mensajes para reaccionar
‚Ä¢ ‚Ü©Ô∏è Respuestas: Responde a mensajes espec√≠ficos
‚Ä¢ üîç B√∫squeda: Busca por usuario, mensaje o fecha
‚Ä¢ ‚úçÔ∏è Indicador de escritura: Ve cuando otros est√°n escribiendo
‚Ä¢ üìä Roles: Admin, Moderador, Usuario, Invitado

ÔøΩüë• FUNCIONES:
‚Ä¢ Lista de usuarios conectados
‚Ä¢ Mensajes en tiempo real
‚Ä¢ Reconexi√≥n autom√°tica
‚Ä¢ Modo invitado disponible

üí° CONSEJOS:
‚Ä¢ M√°ximo 500 caracteres por mensaje
‚Ä¢ El chat es p√∫blico para todos
‚Ä¢ Tu estado se actualiza autom√°ticamente
‚Ä¢ Las reacciones son visibles para todos
‚Ä¢ Usa las respuestas para conversaciones claras
‚Ä¢ El indicador "escribiendo" se activa autom√°ticamente
            `;
            
            alert(ayuda);
        }

        // üîê FUNCIONES DE AUTENTICACI√ìN DE ADMINISTRADOR SEGURA
        
        function solicitarAutenticacionAdmin() {
            const modal = document.createElement('div');
            modal.className = 'admin-auth-modal';
            modal.innerHTML = `
                <div class="admin-auth-content">
                    <div class="auth-header">
                        <h3>üîê Autenticaci√≥n de Administrador</h3>
                        <p>Ingresa tu c√≥digo de administrador seguro</p>
                    </div>
                    <div class="auth-form">
                        <input type="password" id="adminCode" placeholder="C√≥digo de administrador..." class="admin-auth-input">
                        <input type="text" id="admin2FA" placeholder="C√≥digo 2FA (opcional)" class="admin-auth-input">
                        <div class="auth-buttons">
                            <button onclick="autenticarAdmin()" class="auth-btn primary">üîì Autenticar</button>
                            <button onclick="cerrarAutenticacionAdmin()" class="auth-btn secondary">‚ùå Cancelar</button>
                        </div>
                    </div>
                    <div class="auth-info">
                        <small>‚ö†Ô∏è Los intentos fallidos son registrados y monitoreados</small>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('adminCode').focus();
            
            // Permitir Enter para autenticar
            document.getElementById('adminCode').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') autenticarAdmin();
            });
        }
        
        function autenticarAdmin() {
            const codigo = document.getElementById('adminCode').value;
            const codigo2FA = document.getElementById('admin2FA').value;
            const userIP = '127.0.0.1'; // En producci√≥n ser√≠a la IP real
            
            // Verificar si el usuario est√° bloqueado
            const lockKey = `${currentUser}-${userIP}`;
            const failedAttempts = failedAdminAttempts.get(lockKey) || { count: 0, lastAttempt: 0 };
            
            if (failedAttempts.count >= securityConfig.adminSystem.maxFailedAttempts) {
                const tiempoRestante = Math.ceil((securityConfig.adminSystem.lockoutDuration - (Date.now() - failedAttempts.lastAttempt)) / 60000);
                if (tiempoRestante > 0) {
                    mostrarNotificacion(`üö´ Acceso bloqueado por ${tiempoRestante} minutos m√°s`, 'error');
                    cerrarAutenticacionAdmin();
                    return;
                }
            }
            
            // Verificar c√≥digo de administrador
            const adminData = securityConfig.adminSystem.adminCodes[codigo];
            
            if (!adminData) {
                registrarIntentoFallido(lockKey);
                mostrarNotificacion('‚ùå C√≥digo de administrador inv√°lido', 'error');
                registrarAuditoria('ADMIN_AUTH_FAILED', currentUser, `C√≥digo inv√°lido: ${codigo.substring(0, 5)}...`);
                return;
            }
            
            // Verificar expiraci√≥n
            if (adminData.expira < Date.now()) {
                mostrarNotificacion('‚è∞ C√≥digo de administrador expirado', 'error');
                registrarAuditoria('ADMIN_AUTH_EXPIRED', currentUser, 'C√≥digo expirado');
                return;
            }
            
            // Verificar si el usuario coincide (opcional)
            if (adminData.usuario && adminData.usuario !== currentUser) {
                registrarIntentoFallido(lockKey);
                mostrarNotificacion('üö´ Este c√≥digo no est√° asociado a tu usuario', 'error');
                registrarAuditoria('ADMIN_AUTH_USER_MISMATCH', currentUser, `C√≥digo para: ${adminData.usuario}`);
                return;
            }
            
            // Autenticaci√≥n exitosa
            currentAdminLevel = adminData.nivel;
            const sessionToken = generarTokenSeguro();
            const sessionData = {
                usuario: currentUser,
                nivel: adminData.nivel,
                inicio: Date.now(),
                expira: Date.now() + securityConfig.adminSystem.sessionTimeout,
                token: sessionToken
            };
            
            adminSessions.set(currentUser, sessionData);
            adminTokens.set(sessionToken, sessionData);
            
            // Limpiar intentos fallidos
            failedAdminAttempts.delete(lockKey);
            
            mostrarNotificacion(`‚úÖ Autenticado como ${adminData.nivel.toUpperCase()}`, 'success');
            registrarAuditoria('ADMIN_AUTH_SUCCESS', currentUser, `Nivel: ${adminData.nivel}`);
            
            cerrarAutenticacionAdmin();
            mostrarPanelAdminSeguro();
            
            // Programar expiraci√≥n de sesi√≥n
            setTimeout(() => {
                if (adminSessions.has(currentUser)) {
                    cerrarSesionAdmin();
                    mostrarNotificacion('‚è∞ Sesi√≥n de administrador expirada', 'warning');
                }
            }, securityConfig.adminSystem.sessionTimeout);
        }
        
        function registrarIntentoFallido(lockKey) {
            const actual = failedAdminAttempts.get(lockKey) || { count: 0, lastAttempt: 0 };
            actual.count++;
            actual.lastAttempt = Date.now();
            failedAdminAttempts.set(lockKey, actual);
            
            if (actual.count >= securityConfig.adminSystem.maxFailedAttempts) {
                mostrarNotificacion(`üö® Demasiados intentos fallidos. Bloqueado por ${securityConfig.adminSystem.lockoutDuration / 60000} minutos`, 'error');
                registrarAuditoria('ADMIN_LOCKOUT', currentUser, `IP: ${lockKey}`);
            }
        }
        
        function generarTokenSeguro() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let token = '';
            for (let i = 0; i < 32; i++) {
                token += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return token + '-' + Date.now();
        }
        
        function verificarSesionAdmin() {
            const session = adminSessions.get(currentUser);
            if (!session) return false;
            
            if (session.expira < Date.now()) {
                cerrarSesionAdmin();
                return false;
            }
            
            return true;
        }
        
        function cerrarSesionAdmin() {
            const session = adminSessions.get(currentUser);
            if (session) {
                adminTokens.delete(session.token);
                adminSessions.delete(currentUser);
            }
            currentAdminLevel = null;
            registrarAuditoria('ADMIN_LOGOUT', currentUser, 'Sesi√≥n cerrada');
        }
        
        function cerrarAutenticacionAdmin() {
            const modal = document.querySelector('.admin-auth-modal');
            if (modal) modal.remove();
        }
        
        // Funci√≥n para verificar si el usuario es administrador (reemplaza las verificaciones inseguras)
        function esAdministrador(nivel = 'moderador') {
            if (!verificarSesionAdmin()) return false;
            
            const session = adminSessions.get(currentUser);
            if (!session) return false;
            
            switch (nivel) {
                case 'super':
                    return session.nivel === 'super';
                case 'moderador':
                    return ['super', 'moderador'].includes(session.nivel);
                default:
                    return false;
            }
        }
        // =========================
        
        function inicializarSistemasSeguridad() {
            // Inicializar bot de moderaci√≥n
            inicializarBotModeracion();
            
            // Inicializar temas din√°micos
            inicializarTemasDinamicos();
            
            // Registrar inicializaci√≥n
            registrarAuditoria('SECURITY_SYSTEMS_INIT', currentUser, 'Sistemas de seguridad activados');
            
            // Mostrar mensaje de bienvenida de seguridad
            setTimeout(() => {
                mostrarMensajeBot('ModeradorBot', 
                    'üõ°Ô∏è Sistema de seguridad activado. Monitoreando chat para mantener un ambiente seguro.', 
                    'info'
                );
            }, 2000);
        }
        
        function mostrarPanelAdmin() {
            if (!esAdministrador('moderador')) {
                mostrarNotificacion('üö´ Acceso denegado: Autenticaci√≥n requerida', 'error');
                solicitarAutenticacionAdmin();
                return;
            }
            mostrarPanelAdminSeguro();
        }
        
        function mostrarPanelAdminSeguro() {
            if (!esAdministrador('moderador')) {
                mostrarNotificacion('üö´ Acceso denegado: Autenticaci√≥n requerida', 'error');
                solicitarAutenticacionAdmin();
                return;
            }

            const session = adminSessions.get(currentUser);
            const tiempoRestante = Math.ceil((session.expira - Date.now()) / 60000);
            
            const panelHTML = `
                <div class="admin-panel">
                    <div class="admin-content">
                        <div class="admin-header">
                            <h2>üîê PANEL DE ADMINISTRACI√ìN SEGURO</h2>
                            <div class="admin-session-info">
                                <span class="admin-level">Nivel: ${session.nivel.toUpperCase()}</span>
                                <span class="session-timer">‚è±Ô∏è ${tiempoRestante} min restantes</span>
                                <button onclick="cerrarSesionAdmin(); cerrarPanelAdmin();" class="logout-btn">üö™ Cerrar Sesi√≥n</button>
                            </div>
                        </div>
                        
                        <div class="admin-sections">
                            <div class="admin-section">
                                <h3>üë• Gesti√≥n de Usuarios</h3>
                                <button onclick="mostrarUsuariosConectados()" class="admin-action-btn">Ver Usuarios Conectados</button>
                                <button onclick="mostrarHistorialUsuarios()" class="admin-action-btn">Historial de Usuarios</button>
                                ${session.nivel === 'super' ? '<button onclick="banearUsuario()" class="admin-action-btn danger">üö´ Banear Usuario</button>' : ''}
                            </div>
                            
                            <div class="admin-section">
                                <h3>ÔøΩ Seguridad y Auditor√≠a</h3>
                                <button onclick="mostrarLogsSeguridad()" class="admin-action-btn">Ver Logs de Seguridad</button>
                                <button onclick="mostrarActividadSospechosa()" class="admin-action-btn">Actividad Sospechosa</button>
                                <button onclick="mostrarIntentosIntrusi√≥n()" class="admin-action-btn">Intentos de Intrusi√≥n</button>
                            </div>
                            
                            <div class="admin-section">
                                <h3>üõ†Ô∏è Configuraci√≥n del Sistema</h3>
                                <button onclick="configurarSistema()" class="admin-action-btn">Configurar Sistema</button>
                                <button onclick="actualizarCodigosAdmin()" class="admin-action-btn">Gestionar C√≥digos Admin</button>
                                ${session.nivel === 'super' ? '<button onclick="resetearSistema()" class="admin-action-btn danger">‚ö†Ô∏è Reset Sistema</button>' : ''}
                            </div>
                            
                            <div class="admin-section">
                                <h3>üìà Estad√≠sticas</h3>
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <span class="stat-number">${connectedUsers.size}</span>
                                        <span class="stat-label">Usuarios Online</span>
                                    </div>
                                    <div class="stat-card">
                                        <span class="stat-number">${auditLogs.length}</span>
                                        <span class="stat-label">Eventos de Auditor√≠a</span>
                                    </div>
                                    <div class="stat-card">
                                        <span class="stat-number">${failedAdminAttempts.size}</span>
                                        <span class="stat-label">Intentos Admin Fallidos</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="admin-footer">
                            <button onclick="cerrarPanelAdmin()" class="close-panel-btn">‚ùå Cerrar Panel</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', panelHTML);
            registrarAuditoria('ADMIN_PANEL_ACCESS', currentUser, `Nivel: ${session.nivel}`);
        }
        
        function cerrarPanelAdmin() {
            const panel = document.querySelector('.admin-panel');
            if (panel) panel.remove();
        }
        
        function mostrarAuditLogs() {
            if (!esAdministrador('moderador')) {
                mostrarNotificacion('üö´ Acceso denegado: Solo administradores', 'error');
                return;
            }
            
            const ultimosLogs = auditLogs.slice(-20).reverse();
            let logsText = 'üìä AUDIT LOGS (√öltimos 20 eventos)\n\n';
            
            ultimosLogs.forEach(log => {
                const fecha = new Date(log.timestamp).toLocaleString();
                logsText += `[${fecha}] ${log.evento}: ${log.usuario} - ${log.detalle}\n`;
            });
            
            if (ultimosLogs.length === 0) {
                logsText += 'No hay logs disponibles.';
            }
            
            alert(logsText);
            registrarAuditoria('AUDIT_LOGS_VIEW', currentUser, 'Logs de auditor√≠a consultados');
        }
        
        function mostrarEstadoSeguridad() {
            const amenazasDetectadas = auditLogs.filter(log => 
                ['SPAM_DETECTED', 'INTRUSION_ALERT', 'IP_BLOCKED', 'MESSAGE_CENSORED'].includes(log.evento)
            ).length;
            
            const usuariosSospechosos = suspiciousActivity.size;
            const mensajesCensurados = auditLogs.filter(log => log.evento === 'MESSAGE_CENSORED').length;
            
            const estado = `
üõ°Ô∏è ESTADO DE SEGURIDAD

üìà M√âTRICAS EN TIEMPO REAL:
‚Ä¢ Amenazas detectadas: ${amenazasDetectadas}
‚Ä¢ Usuarios bajo vigilancia: ${usuariosSospechosos}
‚Ä¢ Mensajes censurados: ${mensajesCensurados}
‚Ä¢ Conexiones activas: ${connectedUsers.size}

üîç ACTIVIDAD RECIENTE:
${auditLogs.slice(-5).map(log => 
    `‚Ä¢ ${log.evento}: ${log.usuario} - ${new Date(log.timestamp).toLocaleTimeString()}`
).join('\n')}

‚öôÔ∏è SISTEMAS ACTIVOS:
‚Ä¢ Anti-spam ML: ${securityConfig.antiSpam.enabled ? 'üü¢' : 'üî¥'}
‚Ä¢ Control de IP: ${securityConfig.ipControl.enabled ? 'üü¢' : 'üî¥'}
‚Ä¢ Detecci√≥n intrusos: ${securityConfig.intrusionDetection.enabled ? 'üü¢' : 'üî¥'}
‚Ä¢ Bot moderador: ${moderationBot ? 'üü¢' : 'üî¥'}
‚Ä¢ Temas din√°micos: ${themeScheduler ? 'üü¢' : 'üî¥'}
            `;
            
            alert(estado);
            registrarAuditoria('SECURITY_STATUS_VIEW', currentUser, 'Estado de seguridad consultado');
        }
        
        function procesarComandoAdmin(comando, parametros) {
            // ‚ö° COMANDO ESPECIAL: /admin no requiere permisos (es para autenticarse)
            if (comando.toLowerCase() === '/admin') {
                mostrarPanelAdmin();
                return true;
            }
            
            // ‚ö° COMANDO R√ÅPIDO: /quickadmin para acceso directo
            if (comando.toLowerCase() === '/quickadmin') {
                const codigo = parametros[0];
                if (codigo) {
                    autenticarAdministrador(codigo);
                } else {
                    mostrarNotificacion('üí° Uso: /quickadmin CODIGO', 'info');
                    mostrarNotificacion('üîë C√≥digos disponibles: GRAPE-ADMIN-2025-SECURE, MOD-HELPER-SECURE-2025, DIAMOND-ADMIN-SECURE-2025', 'info');
                }
                return true;
            }
            
            // ‚ö° COMANDO ESPECIAL: /debug disponible para todos
            if (comando.toLowerCase() === '/debug') {
                const hasSession = adminSessions.has(currentUser);
                const session = hasSession ? adminSessions.get(currentUser) : null;
                const debugInfo = [
                    `üîç ESTADO DE ADMINISTRADOR:`,
                    `üìä Usuario: ${currentUser}`,
                    `üîë Es Super Admin: ${esAdministrador('super')}`,
                    `üîí Es Moderador: ${esAdministrador('moderador')}`,
                    `üíº Tiene sesi√≥n activa: ${hasSession}`,
                    session ? `üìã Nivel: ${session.nivel}` : '‚ùå Sin sesi√≥n',
                    session ? `‚è∞ Expira en: ${Math.round((session.expira - Date.now()) / 1000 / 60)} min` : '',
                    `üìù Total c√≥digos disponibles: ${Object.keys(securityConfig.adminSystem.adminCodes).length}`,
                    '',
                    `üí° Si no tienes rol admin, usa: /admin`
                ].filter(line => line).join('\n');
                
                agregarMensaje('SystemDebug', debugInfo, new Date().toLocaleTimeString(), false);
                return true;
            }
            
            // üîê PARA OTROS COMANDOS: Verificar permisos de administrador
            if (!esAdministrador('moderador')) {
                mostrarNotificacion('üö´ Acceso denegado. Usa /admin para autenticarte primero', 'error');
                return false;
            }
            
            switch(comando.toLowerCase()) {
                case '/logs':
                    mostrarAuditLogs();
                    return true;
                    
                case '/security':
                    mostrarEstadoSeguridad();
                    return true;
                    
                case '/block':
                    if (parametros[0]) {
                        blockedUsers.add(parametros[0]);
                        mostrarNotificacion(`üö´ Usuario ${parametros[0]} bloqueado`, 'success');
                        registrarAuditoria('USER_BLOCKED', currentUser, `Usuario bloqueado: ${parametros[0]}`);
                    }
                    return true;
                    
                case '/unblock':
                    if (parametros[0]) {
                        blockedUsers.delete(parametros[0]);
                        mostrarNotificacion(`‚úÖ Usuario ${parametros[0]} desbloqueado`, 'success');
                        registrarAuditoria('USER_UNBLOCKED', currentUser, `Usuario desbloqueado: ${parametros[0]}`);
                    }
                    return true;
                    
                case '/ban_ip':
                    if (parametros[0]) {
                        securityConfig.ipControl.blacklist.add(parametros[0]);
                        mostrarNotificacion(`üö´ IP ${parametros[0]} bloqueada`, 'success');
                        registrarAuditoria('IP_BANNED', currentUser, `IP bloqueada: ${parametros[0]}`);
                    }
                    return true;
                    
                case '/whitelist':
                    if (parametros[0]) {
                        securityConfig.ipControl.whitelist.add(parametros[0]);
                        mostrarNotificacion(`‚úÖ IP ${parametros[0]} agregada a whitelist`, 'success');
                        registrarAuditoria('IP_WHITELISTED', currentUser, `IP en whitelist: ${parametros[0]}`);
                    }
                    return true;
                    
                default:
                    return false;
            }
        }
        
        function isToday(timestamp) {
            const today = new Date();
            const date = new Date(timestamp);
            return date.toDateString() === today.toDateString();
        }

        function mostrarEmojis() {
            const emojis = ['üòä', 'üòÇ', '‚ù§Ô∏è', 'üëç', 'üëé', 'üò¢', 'üòÆ', 'üò°', 'ü§î', 'üòé', 'üî•', 'üíØ', 'üëå', 'üôå', 'üòç'];
            const input = document.getElementById('messageInput');
            
            // Crear un panel de emojis simple
            const emojiPanel = prompt('Selecciona un emoji:\n' + emojis.join(' ') + '\n\nEscribe el n√∫mero (1-' + emojis.length + '):');
            
            if (emojiPanel && !isNaN(emojiPanel)) {
                const index = parseInt(emojiPanel) - 1;
                if (index >= 0 && index < emojis.length) {
                    input.value += emojis[index];
                    input.focus();
                }
            }
        }

        function desconectar() {
            if (confirm('¬øEst√°s seguro de que quieres salir del chat?')) {
                // Detener indicador de escritura antes de desconectar
                if (isTyping) {
                    enviarAlServidor({
                        tipo: 'typing_stop',
                        usuario: currentUser
                    });
                }
                
                if (ws) {
                    enviarAlServidor({
                        tipo: 'user_disconnected',
                        usuario: currentUser
                    });
                    ws.close();
                }
                
                // Reset de variables
                currentUser = '';
                messageCount = 0;
                connectedUsers.clear();
                allMessages = [];
                messageReactions.clear();
                typingUsers.clear();
                isTyping = false;
                
                if (typingTimer) {
                    clearTimeout(typingTimer);
                }
                
                // Volver a la pantalla de login
                document.getElementById('chatContainer').classList.add('hidden');
                document.getElementById('loginContainer').classList.remove('hidden');
                
                // Limpiar campos
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('messages').innerHTML = '';
                
                actualizarStatus('offline', '‚ùå Desconectado');
            }
        }

        // =========================
        // SISTEMA DE REACCIONES
        // =========================
        function agregarReaccion(messageId, emoji) {
            if (!messageReactions.has(messageId)) {
                messageReactions.set(messageId, new Map());
            }
            
            const reactions = messageReactions.get(messageId);
            if (!reactions.has(emoji)) {
                reactions.set(emoji, new Set());
            }
            
            const users = reactions.get(emoji);
            if (users.has(currentUser)) {
                users.delete(currentUser);
                if (users.size === 0) {
                    reactions.delete(emoji);
                }
            } else {
                users.add(currentUser);
            }
            
            actualizarReaccionesUI(messageId);
            
            // Enviar reacci√≥n al servidor (para sincronizar con otros usuarios)
            enviarAlServidor({
                tipo: 'reaccion',
                messageId: messageId,
                emoji: emoji,
                usuario: currentUser,
                accion: users.has(currentUser) ? 'agregar' : 'quitar'
            });
        }

        function actualizarReaccionesUI(messageId) {
            const reactionsContainer = document.getElementById(`reactions_${messageId}`);
            if (!reactionsContainer) return;
            
            reactionsContainer.innerHTML = '';
            
            const reactions = messageReactions.get(messageId);
            if (!reactions || reactions.size === 0) return;
            
            reactions.forEach((users, emoji) => {
                if (users.size > 0) {
                    const reactionDiv = document.createElement('div');
                    reactionDiv.className = `reaction-item ${users.has(currentUser) ? 'user-reacted' : ''}`;
                    reactionDiv.onclick = () => agregarReaccion(messageId, emoji);
                    reactionDiv.title = `Reaccionaron: ${Array.from(users).join(', ')}`;
                    
                    reactionDiv.innerHTML = `
                        <span class="reaction-emoji">${emoji}</span>
                        <span class="reaction-count">${users.size}</span>
                    `;
                    
                    reactionsContainer.appendChild(reactionDiv);
                }
            });
            
            // Bot√≥n para agregar m√°s reacciones
            const addReactionBtn = document.createElement('div');
            addReactionBtn.className = 'add-reaction-btn';
            addReactionBtn.textContent = '+ üòä';
            addReactionBtn.title = 'Agregar reacci√≥n';
            addReactionBtn.onclick = () => mostrarMenuReacciones(messageId);
            reactionsContainer.appendChild(addReactionBtn);
        }

        function mostrarMenuReacciones(messageId) {
            const emojis = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üò°', 'üî•', 'üíØ', 'üëå', 'üôå', 'üòç', 'ü§î', 'üòé', 'üéâ', 'üí™'];
            const emoji = prompt('Selecciona una reacci√≥n:\n' + emojis.join(' ') + '\n\nEscribe el emoji o el n√∫mero (1-' + emojis.length + '):');
            
            if (emoji) {
                if (!isNaN(emoji)) {
                    const index = parseInt(emoji) - 1;
                    if (index >= 0 && index < emojis.length) {
                        agregarReaccion(messageId, emojis[index]);
                    }
                } else {
                    agregarReaccion(messageId, emoji);
                }
            }
        }

        // =========================
        // SISTEMA DE B√öSQUEDA
        // =========================
        function toggleSearch() {
            const searchPanel = document.getElementById('searchPanel');
            isSearchOpen = !isSearchOpen;
            
            if (isSearchOpen) {
                searchPanel.classList.remove('hidden');
                document.getElementById('searchInput').focus();
            } else {
                searchPanel.classList.add('hidden');
                limpiarBusqueda();
            }
        }

        function buscarMensajes() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('searchResults');
            
            if (!query) {
                resultsContainer.innerHTML = '';
                return;
            }
            
            const resultados = allMessages.filter(msg => {
                return msg.usuario.toLowerCase().includes(query) ||
                       msg.mensaje.toLowerCase().includes(query) ||
                       formatearTiempo(msg.timestamp).includes(query);
            }).slice(0, 10); // Limitar a 10 resultados
            
            resultsContainer.innerHTML = '';
            
            if (resultados.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No se encontraron mensajes</div>';
                return;
            }
            
            resultados.forEach(msg => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'search-result-item';
                resultDiv.onclick = () => scrollToMessage(msg.id);
                
                // Resaltar t√©rminos de b√∫squeda
                const usuario = resaltarTexto(msg.usuario, query);
                const mensaje = resaltarTexto(msg.mensaje, query);
                const tiempo = resaltarTexto(formatearTiempo(msg.timestamp), query);
                
                resultDiv.innerHTML = `
                    <div class="search-result-user">${usuario}</div>
                    <div class="search-result-text">${mensaje}</div>
                    <div class="search-result-time">${tiempo}</div>
                `;
                
                resultsContainer.appendChild(resultDiv);
            });
        }

        function resaltarTexto(texto, query) {
            const regex = new RegExp(`(${query})`, 'gi');
            return texto.replace(regex, '<span class="search-highlight">$1</span>');
        }

        function scrollToMessage(messageId) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Efecto de resaltado temporal
                messageElement.style.backgroundColor = 'rgba(102, 126, 234, 0.2)';
                setTimeout(() => {
                    messageElement.style.backgroundColor = '';
                }, 2000);
            }
        }

        function limpiarBusqueda() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').innerHTML = '';
        }

        // =========================
        // SISTEMA DE RESPUESTAS
        // =========================
        function responderMensaje(messageId, usuario, mensaje) {
            replyingTo = { messageId, usuario, mensaje };
            
            // Mostrar indicador de respuesta
            const replyIndicator = document.getElementById('replyIndicator');
            const replyToUser = document.getElementById('replyToUser');
            const replyToText = document.getElementById('replyToText');
            
            replyToUser.textContent = `Respondiendo a ${usuario}:`;
            replyToText.textContent = mensaje.length > 60 ? mensaje.substring(0, 60) + '...' : mensaje;
            
            replyIndicator.classList.remove('hidden');
            
            // Enfocar en el input
            document.getElementById('messageInput').focus();
        }

        function cancelarRespuesta() {
            replyingTo = null;
            document.getElementById('replyIndicator').classList.add('hidden');
        }

        function manejarReaccionRecibida(data) {
            const { messageId, emoji, usuario, accion } = data;
            
            if (!messageReactions.has(messageId)) {
                messageReactions.set(messageId, new Map());
            }
            
            const reactions = messageReactions.get(messageId);
            if (!reactions.has(emoji)) {
                reactions.set(emoji, new Set());
            }
            
            const users = reactions.get(emoji);
            if (accion === 'agregar') {
                users.add(usuario);
            } else {
                users.delete(usuario);
                if (users.size === 0) {
                    reactions.delete(emoji);
                }
            }
            
            actualizarReaccionesUI(messageId);
        }

        // =========================
        // INDICADOR DE ESCRITURA
        // =========================
        function actualizarIndicadorEscritura() {
            const messagesDiv = document.getElementById('messages');
            
            // Remover indicador anterior si existe
            const existingIndicator = document.getElementById('typingIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // Si hay usuarios escribiendo, mostrar indicador
            if (typingUsers.size > 0) {
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typingIndicator';
                typingDiv.className = 'typing-users-indicator';
                
                const usersArray = Array.from(typingUsers);
                let typingText = '';
                
                if (usersArray.length === 1) {
                    typingText = `<span class="typing-user-name">${usersArray[0]}</span> est√° escribiendo`;
                } else if (usersArray.length === 2) {
                    typingText = `<span class="typing-user-name">${usersArray[0]}</span> y <span class="typing-user-name">${usersArray[1]}</span> est√°n escribiendo`;
                } else {
                    typingText = `<span class="typing-user-name">${usersArray[0]}</span>, <span class="typing-user-name">${usersArray[1]}</span> y ${usersArray.length - 2} m√°s est√°n escribiendo`;
                }
                
                typingDiv.innerHTML = `
                    <div class="typing-users-list">${typingText}...</div>
                    <div class="typing-animation">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;
                
                messagesDiv.appendChild(typingDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        // =========================
        // SISTEMA DE CANALES Y SALAS
        // =========================
        function crearNuevoCanal() {
            const nombre = prompt('üè† Nombre del nuevo canal:');
            if (!nombre || nombre.trim().length < 2) {
                mostrarNotificacion('El nombre del canal debe tener al menos 2 caracteres', 'error');
                return;
            }
            
            const tipo = confirm('¬øCrear canal privado? (Cancelar = P√∫blico)') ? 'private' : 'public';
            const channelId = 'canal_' + Date.now();
            
            activeChannels.set(channelId, {
                name: nombre.trim(),
                type: tipo,
                creator: currentUser,
                members: new Set([currentUser]),
                messages: []
            });
            
            agregarTabCanal(channelId, nombre, tipo);
            cambiarCanal(channelId);
            
            enviarAlServidor({
                tipo: 'create_channel',
                channelId: channelId,
                name: nombre.trim(),
                channelType: tipo,
                creator: currentUser
            });
            
            mostrarNotificacion(`Canal "${nombre}" creado exitosamente`, 'success');
        }

        function agregarTabCanal(channelId, nombre, tipo) {
            const channelTabs = document.getElementById('channelTabs');
            const addBtn = channelTabs.querySelector('.add-channel-btn');
            
            const tab = document.createElement('div');
            tab.className = `channel-tab ${tipo === 'private' ? 'private' : ''}`;
            tab.setAttribute('data-channel', channelId);
            tab.onclick = () => cambiarCanal(channelId);
            
            const icon = tipo === 'private' ? 'üîí' : 'üì¢';
            tab.innerHTML = `
                <span>${icon} ${nombre}</span>
                <span class="close-channel" onclick="event.stopPropagation(); cerrarCanal('${channelId}')">&times;</span>
            `;
            
            channelTabs.insertBefore(tab, addBtn);
        }

        function cambiarCanal(channelId) {
            // Actualizar tabs activos
            document.querySelectorAll('.channel-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`[data-channel="${channelId}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            currentChannel = channelId;
            
            // Actualizar t√≠tulo del chat
            const channel = activeChannels.get(channelId);
            if (channel) {
                document.getElementById('currentChannelTitle').textContent = 
                    `${channel.type === 'private' ? 'üîí' : 'üì¢'} ${channel.name}`;
                document.getElementById('currentChannelSubtitle').textContent = 
                    channel.type === 'private' ? 'Canal privado' : 'Canal p√∫blico';
            } else if (channelId === 'general') {
                document.getElementById('currentChannelTitle').textContent = 'üí¨ Sala General';
                document.getElementById('currentChannelSubtitle').textContent = 'Chat p√∫blico para todos los usuarios';
            }
            
            // Limpiar mensajes y cargar los del canal actual
            document.getElementById('messages').innerHTML = '';
            cargarMensajesCanal(channelId);
            
            enviarAlServidor({
                tipo: 'join_channel',
                channelId: channelId,
                usuario: currentUser
            });
        }

        function cerrarCanal(channelId) {
            if (channelId === 'general') {
                mostrarNotificacion('No puedes cerrar el canal general', 'error');
                return;
            }
            
            activeChannels.delete(channelId);
            
            const tab = document.querySelector(`[data-channel="${channelId}"]`);
            if (tab) {
                tab.remove();
            }
            
            // Si estaba en ese canal, cambiar al general
            if (currentChannel === channelId) {
                cambiarCanal('general');
            }
            
            enviarAlServidor({
                tipo: 'leave_channel',
                channelId: channelId,
                usuario: currentUser
            });
        }

        function cargarMensajesCanal(channelId) {
            const channel = activeChannels.get(channelId);
            if (channel && channel.messages) {
                channel.messages.forEach(msg => {
                    mostrarMensajeEnChat(msg.usuario, msg.mensaje, msg.usuario === currentUser, msg.timestamp, msg.replyTo);
                });
            }
        }

        // =========================
        // MENSAJES PRIVADOS
        // =========================
        function iniciarChatPrivado(usuario) {
            if (usuario === currentUser) {
                mostrarNotificacion('No puedes chatear contigo mismo', 'error');
                return;
            }
            
            const chatId = `private_${[currentUser, usuario].sort().join('_')}`;
            
            if (!privateChats.has(chatId)) {
                privateChats.set(chatId, {
                    participants: [currentUser, usuario],
                    messages: []
                });
            }
            
            // Crear tab para chat privado
            agregarTabCanal(chatId, `üí¨ ${usuario}`, 'private');
            cambiarCanal(chatId);
            
            enviarAlServidor({
                tipo: 'start_private_chat',
                chatId: chatId,
                participants: [currentUser, usuario]
            });
        }

        // =========================
        // LISTA DE AMIGOS
        // =========================
        function agregarAmigo() {
            const username = prompt('üë§ Nombre de usuario para agregar como amigo:');
            if (!username || username.trim().length < 2) {
                mostrarNotificacion('Ingresa un nombre de usuario v√°lido', 'error');
                return;
            }
            
            if (username === currentUser) {
                mostrarNotificacion('No puedes agregarte a ti mismo como amigo', 'error');
                return;
            }
            
            if (friendsList.has(username)) {
                mostrarNotificacion('Este usuario ya est√° en tu lista de amigos', 'error');
                return;
            }
            
            friendsList.add(username);
            actualizarListaAmigos();
            
            enviarAlServidor({
                tipo: 'add_friend',
                friend: username,
                usuario: currentUser
            });
            
            mostrarNotificacion(`${username} agregado a tu lista de amigos`, 'success');
        }

        function actualizarListaAmigos() {
            const friendsList_div = document.getElementById('friendsList');
            friendsList_div.innerHTML = '';
            
            friendsList.forEach(friend => {
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item';
                
                const isOnline = connectedUsers.has(friend);
                const statusClass = isOnline ? 'online' : 'offline';
                
                friendItem.innerHTML = `
                    <div class="friend-status ${statusClass}"></div>
                    <div class="friend-name">${friend}</div>
                    <div class="friend-actions">
                        <button class="friend-action-btn chat-btn" onclick="iniciarChatPrivado('${friend}')" title="Chat privado">üí¨</button>
                        <button class="friend-action-btn block-btn" onclick="bloquearUsuario('${friend}')" title="Bloquear">üö´</button>
                    </div>
                `;
                
                friendsList_div.appendChild(friendItem);
            });
        }

        function bloquearUsuario(usuario) {
            if (confirm(`¬øEst√°s seguro de que quieres bloquear a ${usuario}?`)) {
                blockedUsers.add(usuario);
                friendsList.delete(usuario);
                actualizarListaAmigos();
                
                enviarAlServidor({
                    tipo: 'block_user',
                    blockedUser: usuario,
                    usuario: currentUser
                });
                
                mostrarNotificacion(`${usuario} ha sido bloqueado`, 'success');
            }
        }

        // =========================
        // SISTEMA DE ENCUESTAS
        // =========================
        function crearEncuesta() {
            const pregunta = prompt('üìä Pregunta de la encuesta:');
            if (!pregunta || pregunta.trim().length < 5) {
                mostrarNotificacion('La pregunta debe tener al menos 5 caracteres', 'error');
                return;
            }
            
            const opciones = [];
            for (let i = 1; i <= 4; i++) {
                const opcion = prompt(`Opci√≥n ${i} (opcional):`);
                if (opcion && opcion.trim().length > 0) {
                    opciones.push(opcion.trim());
                }
            }
            
            if (opciones.length < 2) {
                mostrarNotificacion('La encuesta debe tener al menos 2 opciones', 'error');
                return;
            }
            
            const pollId = 'poll_' + Date.now();
            const poll = {
                id: pollId,
                question: pregunta.trim(),
                options: opciones.map(opt => ({ text: opt, votes: 0, voters: new Set() })),
                creator: currentUser,
                channel: currentChannel,
                timestamp: new Date().toISOString()
            };
            
            activePolls.set(pollId, poll);
            mostrarEncuestaEnChat(poll);
            
            enviarAlServidor({
                tipo: 'create_poll',
                poll: {
                    ...poll,
                    options: poll.options.map(opt => ({ ...opt, voters: Array.from(opt.voters) }))
                }
            });
        }

        function mostrarEncuestaEnChat(poll) {
            const messagesDiv = document.getElementById('messages');
            const pollDiv = document.createElement('div');
            pollDiv.className = 'poll-container';
            pollDiv.id = `poll_${poll.id}`;
            
            let totalVotes = poll.options.reduce((sum, opt) => sum + opt.votes, 0);
            
            let optionsHTML = poll.options.map((option, index) => {
                const percentage = totalVotes > 0 ? Math.round((option.votes / totalVotes) * 100) : 0;
                const hasVoted = option.voters.has(currentUser);
                
                return `
                    <div class="poll-option ${hasVoted ? 'voted' : ''}" onclick="votarEncuesta('${poll.id}', ${index})" style="position: relative;">
                        <div class="poll-bar" style="width: ${percentage}%"></div>
                        <span>${option.text}</span>
                        <span class="poll-votes">${option.votes}</span>
                    </div>
                `;
            }).join('');
            
            pollDiv.innerHTML = `
                <div class="poll-question">üìä ${poll.question}</div>
                ${optionsHTML}
                <div style="margin-top: 10px; font-size: 11px; color: var(--text-secondary);">
                    Por ${poll.creator} ‚Ä¢ Total: ${totalVotes} votos
                </div>
            `;
            
            messagesDiv.appendChild(pollDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function votarEncuesta(pollId, optionIndex) {
            const poll = activePolls.get(pollId);
            if (!poll) return;
            
            // Verificar si ya vot√≥ en esta encuesta
            const hasVotedBefore = poll.options.some(opt => opt.voters.has(currentUser));
            
            if (hasVotedBefore) {
                // Remover voto anterior
                poll.options.forEach(opt => {
                    if (opt.voters.has(currentUser)) {
                        opt.voters.delete(currentUser);
                        opt.votes--;
                    }
                });
            }
            
            // Agregar nuevo voto
            poll.options[optionIndex].voters.add(currentUser);
            poll.options[optionIndex].votes++;
            
            // Actualizar UI
            actualizarEncuestaUI(poll);
            
            enviarAlServidor({
                tipo: 'vote_poll',
                pollId: pollId,
                optionIndex: optionIndex,
                usuario: currentUser
            });
        }

        function actualizarEncuestaUI(poll) {
            const pollDiv = document.getElementById(`poll_${poll.id}`);
            if (!pollDiv) return;
            
            let totalVotes = poll.options.reduce((sum, opt) => sum + opt.votes, 0);
            
            poll.options.forEach((option, index) => {
                const percentage = totalVotes > 0 ? Math.round((option.votes / totalVotes) * 100) : 0;
                const hasVoted = option.voters.has(currentUser);
                
                const optionElement = pollDiv.children[index + 1]; // +1 por la pregunta
                if (optionElement) {
                    optionElement.className = `poll-option ${hasVoted ? 'voted' : ''}`;
                    const bar = optionElement.querySelector('.poll-bar');
                    const votes = optionElement.querySelector('.poll-votes');
                    
                    if (bar) bar.style.width = `${percentage}%`;
                    if (votes) votes.textContent = option.votes;
                }
            });
            
            // Actualizar total
            const totalElement = pollDiv.querySelector('div:last-child');
            if (totalElement) {
                totalElement.innerHTML = `Por ${poll.creator} ‚Ä¢ Total: ${totalVotes} votos`;
            }
        }

        // =========================
        // CIFRADO END-TO-END
        // =========================
        function inicializarCifrado() {
            // Generar clave de cifrado simple (en un entorno real usar librer√≠as m√°s robustas)
            encryptionKey = btoa(currentUser + '_' + Date.now()).substring(0, 16);
            mostrarNotificacion('üîê Cifrado activado para mensajes privados', 'success');
        }

        function cifrarMensaje(mensaje) {
            if (!encryptionKey) return mensaje;
            
            // Cifrado simple XOR (en producci√≥n usar AES)
            let encrypted = '';
            for (let i = 0; i < mensaje.length; i++) {
                const charCode = mensaje.charCodeAt(i) ^ encryptionKey.charCodeAt(i % encryptionKey.length);
                encrypted += String.fromCharCode(charCode);
            }
            return btoa(encrypted);
        }

        function descifrarMensaje(mensajeCifrado) {
            if (!encryptionKey) return mensajeCifrado;
            
            try {
                const encrypted = atob(mensajeCifrado);
                let decrypted = '';
                for (let i = 0; i < encrypted.length; i++) {
                    const charCode = encrypted.charCodeAt(i) ^ encryptionKey.charCodeAt(i % encryptionKey.length);
                    decrypted += String.fromCharCode(charCode);
                }
                return decrypted;
            } catch (e) {
                return mensajeCifrado; // Si no se puede descifrar, mostrar original
            }
        }

        // =========================
        // AUTENTICACI√ìN 2FA
        // =========================
        function toggle2FA() {
            if (is2FAEnabled) {
                if (confirm('¬øDesactivar autenticaci√≥n de dos factores?')) {
                    is2FAEnabled = false;
                    mostrarNotificacion('2FA desactivado', 'success');
                }
            } else {
                mostrar2FASetup();
            }
        }

        function mostrar2FASetup() {
            const modal = document.createElement('div');
            modal.className = 'twofa-modal';
            modal.innerHTML = `
                <div class="twofa-content">
                    <h3>üîê Configurar 2FA</h3>
                    <p>C√≥digo secreto: <strong>${generarCodigo2FA()}</strong></p>
                    <p>Guarda este c√≥digo en un lugar seguro</p>
                    <input type="text" class="twofa-code-input" placeholder="Ingresa el c√≥digo para verificar" maxlength="6">
                    <div style="margin-top: 15px;">
                        <button onclick="verificar2FA()" class="login-btn btn-primary" style="margin-right: 10px;">Verificar</button>
                        <button onclick="cerrar2FAModal()" class="login-btn btn-secondary">Cancelar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function generarCodigo2FA() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        function verificar2FA() {
            const input = document.querySelector('.twofa-code-input');
            const codigo = input.value.trim();
            
            if (codigo.length === 6 && /^\d+$/.test(codigo)) {
                is2FAEnabled = true;
                cerrar2FAModal();
                mostrarNotificacion('2FA activado exitosamente', 'success');
                
                enviarAlServidor({
                    tipo: 'enable_2fa',
                    usuario: currentUser,
                    code: codigo
                });
            } else {
                mostrarNotificacion('C√≥digo inv√°lido', 'error');
            }
        }

        function cerrar2FAModal() {
            const modal = document.querySelector('.twofa-modal');
            if (modal) modal.remove();
        }

        // =========================
        // SISTEMA DE BOTS
        // =========================
        function inicializarBots() {
            // Bot de bienvenida
            chatBots.set('welcomeBot', {
                name: 'WelcomeBot',
                description: 'Bot de bienvenida',
                active: true,
                commands: ['/welcome', '/info']
            });
            
            // Bot de moderaci√≥n
            chatBots.set('modBot', {
                name: 'ModBot',
                description: 'Bot de moderaci√≥n',
                active: true,
                commands: ['/kick', '/ban', '/warn']
            });
            
            // Bot de entretenimiento
            chatBots.set('funBot', {
                name: 'FunBot',
                description: 'Bot de entretenimiento',
                active: true,
                commands: ['/joke', '/fact', '/quote']
            });
        }

        function mostrarBots() {
            const bots = Array.from(chatBots.values());
            let botsList = bots.map(bot => 
                `ü§ñ ${bot.name}: ${bot.description}\nComandos: ${bot.commands.join(', ')}`
            ).join('\n\n');
            
            alert(`BOTS DISPONIBLES:\n\n${botsList}\n\nEscribe cualquier comando en el chat para interactuar.`);
        }

        function procesarComandoBot(mensaje) {
            if (!mensaje.startsWith('/')) return false;
            
            const partes = mensaje.split(' ');
            const comando = partes[0].toLowerCase();
            const parametros = partes.slice(1);
            
            // üîê Comandos de administraci√≥n y seguridad
            if (procesarComandoAdmin(comando, parametros)) {
                return true;
            }
            
            // Comandos de seguridad para todos los usuarios
            if (comando === '/security') {
                mostrarEstadoSeguridad();
                return true;
            }
            
            // Bot de bienvenida
            if (comando === '/welcome') {
                enviarMensajeBot('WelcomeBot', `¬°Bienvenido ${currentUser}! üéâ Gracias por unirte a Grapes Fri Chat.`);
                return true;
            }
            
            if (comando === '/info') {
                enviarMensajeBot('WelcomeBot', `üìä Informaci√≥n del chat:\n‚Ä¢ Usuarios conectados: ${connectedUsers.size + 1}\n‚Ä¢ Mensajes enviados: ${messageCount}\n‚Ä¢ Canal actual: ${currentChannel}\n‚Ä¢ Sistema anti-spam: ${securityConfig.antiSpam.enabled ? 'Activo' : 'Inactivo'}\n‚Ä¢ Bot moderador: ${moderationBot ? 'Activo' : 'Inactivo'}`);
                return true;
            }
            
            // Comando de ayuda con comandos de seguridad
            if (comando === '/help' || comando === '/comandos') {
                const ayudaComandos = `
ü§ñ COMANDOS DISPONIBLES:

üëã B√ÅSICOS:
‚Ä¢ /welcome - Mensaje de bienvenida
‚Ä¢ /info - Informaci√≥n del chat
‚Ä¢ /joke - Chiste aleatorio
‚Ä¢ /fact - Dato curioso
‚Ä¢ /quote - Cita inspiradora
‚Ä¢ /security - Estado de seguridad

üõ°Ô∏è SEGURIDAD (Solo admins):
‚Ä¢ /admin - Panel de administraci√≥n
‚Ä¢ /logs - Ver audit logs
‚Ä¢ /block [usuario] - Bloquear usuario
‚Ä¢ /unblock [usuario] - Desbloquear usuario
‚Ä¢ /ban_ip [ip] - Bloquear IP
‚Ä¢ /whitelist [ip] - Agregar a whitelist

‚öôÔ∏è CONFIGURACI√ìN:
‚Ä¢ /clear - Limpiar chat
‚Ä¢ Usa el bot√≥n üîç para buscar mensajes
‚Ä¢ Reacciona con emojis haciendo hover en mensajes
                `;
                enviarMensajeBot('HelpBot', ayudaComandos);
                return true;
            }
            
            // Bot de entretenimiento
            if (comando === '/joke') {
                const jokes = [
                    '¬øPor qu√© los programadores prefieren el modo oscuro? ¬°Porque la luz atrae bugs! üêõ',
                    '¬øCu√°ntos programadores necesitas para cambiar una bombilla? Ninguno, eso es un problema de hardware. üí°',
                    '¬øPor qu√© los desarrolladores usan Mac? Porque no pueden permitirse Windows. üíª',
                    '¬øCu√°l es el animal favorito de los programadores? El Python. üêç',
                    '¬øPor qu√© los hackers nunca se aburren? Porque siempre tienen algo que romper. üîì'
                ];
                const joke = jokes[Math.floor(Math.random() * jokes.length)];
                enviarMensajeBot('FunBot', joke);
                return true;
            }
            
            if (comando === '/fact') {
                const facts = [
                    'üß† El primer bug de computadora fue literalmente un insecto encontrado en 1947.',
                    '‚å®Ô∏è El teclado QWERTY fue dise√±ado para ralentizar la escritura.',
                    'üåê El primer sitio web sigue activo: http://info.cern.ch/hypertext/WWW/TheProject.html',
                    'üíæ El primer virus inform√°tico se llamaba "Creeper" en 1971.',
                    'üîê La contrase√±a m√°s com√∫n del mundo es "123456".'
                ];
                const fact = facts[Math.floor(Math.random() * facts.length)];
                enviarMensajeBot('FunBot', fact);
                return true;
            }
            
            if (comando === '/quote') {
                const quotes = [
                    '"El mejor c√≥digo es el que no necesitas escribir." - Jeff Atwood',
                    '"Habla es barato. Mu√©strame el c√≥digo." - Linus Torvalds',
                    '"El software es como el sexo: es mejor cuando es gratis." - Linus Torvalds',
                    '"Cualquier tonto puede escribir c√≥digo que una computadora entienda. Los buenos programadores escriben c√≥digo que los humanos pueden entender." - Martin Fowler',
                    '"La seguridad no es un producto, sino un proceso." - Bruce Schneier'
                ];
                const quote = quotes[Math.floor(Math.random() * quotes.length)];
                enviarMensajeBot('FunBot', quote);
                return true;
            }
            
            // Comando no reconocido
            enviarMensajeBot('HelpBot', `‚ùì Comando "${comando}" no reconocido. Usa /help para ver todos los comandos disponibles.`);
            return true;
        }

        function enviarMensajeBot(botName, mensaje) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message received';
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.textContent = 'ü§ñ';
            avatarDiv.style.background = 'linear-gradient(45deg, #a29bfe, #fd79a8)';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content bot-message';
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            headerDiv.innerHTML = `
                <div class="message-user-info">
                    <span class="message-username">${botName}</span>
                    <span class="bot-indicator">BOT</span>
                </div>
                <div class="message-time">${formatearTiempo()}</div>
            `;
            
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = mensaje;
            
            contentDiv.appendChild(headerDiv);
            contentDiv.appendChild(textDiv);
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Efecto de aparici√≥n
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translateY(20px)';
            setTimeout(() => {
                messageDiv.style.transition = 'all 0.3s ease';
                messageDiv.style.opacity = '1';
                messageDiv.style.transform = 'translateY(0)';
            }, 50);
        }

        // =========================
        // MODO COMPACTO/EXPANDIDO
        // =========================
        function toggleCompactMode() {
            isCompactMode = !isCompactMode;
            const body = document.body;
            const toggle = document.getElementById('compactToggle');
            
            if (isCompactMode) {
                body.classList.add('compact-mode');
                toggle.classList.add('active');
                toggle.textContent = 'üìã Expandido';
                mostrarNotificacion('Modo compacto activado', 'success');
            } else {
                body.classList.remove('compact-mode');
                toggle.classList.remove('active');
                toggle.textContent = 'üìã Compacto';
                mostrarNotificacion('Modo expandido activado', 'success');
            }
        }

        // =========================
        // INICIALIZACI√ìN
        // =========================
        window.onload = function() {
            console.log('üçá Iniciando Grapes Fri Chat');
            conectarWebSocket();
            
            // Configurar tema por defecto
            cambiarTema('claro');
            
            // Inicializar sistemas avanzados
            inicializarBots();
            actualizarListaAmigos();
            
            // Configurar eventos para modo compacto
            const compactToggle = document.getElementById('compactToggle');
            if (compactToggle) {
                compactToggle.addEventListener('click', toggleCompactMode);
            }
            
            // Configurar eventos para bots
            const botsBtn = document.getElementById('botsBtn');
            if (botsBtn) {
                botsBtn.addEventListener('click', mostrarBots);
            }
            
            // Mostrar mensaje de bienvenida con funciones avanzadas
            setTimeout(() => {
                mostrarNotificacion('üéâ ¬°Grapes Fri Chat cargado con funciones empresariales!', 'success');
                mostrarMensajeSistema('‚ú® Funciones disponibles: Canales m√∫ltiples, Mensajes privados, Amigos, Cifrado, 2FA, Bloqueo, Encuestas, Bots y Modo compacto.');
                mostrarMensajeSistema('ü§ñ Prueba los comandos de bots: /welcome, /info, /joke, /fact, /quote');
            }, 1000);
        };

        // Manejar cierre de ventana
        window.addEventListener('beforeunload', function(e) {
            if (ws && currentUser) {
                enviarAlServidor({
                    tipo: 'user_disconnected',
                    usuario: currentUser
                });
            }
        });

        // üîê INICIALIZACI√ìN DEL SISTEMA DE SEGURIDAD
        // =========================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üõ°Ô∏è Inicializando sistema de seguridad avanzado...');
            
            // Actualizar indicador de seguridad cada 30 segundos
            setInterval(() => {
                const indicator = document.getElementById('securityIndicator');
                if (indicator) {
                    const amenazas = auditLogs.filter(log => 
                        ['SPAM_DETECTED', 'INTRUSION_ALERT', 'IP_BLOCKED'].includes(log.evento)
                    ).length;
                    
                    if (amenazas > 10) {
                        indicator.className = 'security-indicator danger';
                        indicator.textContent = 'üö® Amenazas detectadas';
                    } else if (amenazas > 5) {
                        indicator.className = 'security-indicator warning';
                        indicator.textContent = '‚ö†Ô∏è Vigilancia activa';
                    } else {
                        indicator.className = 'security-indicator';
                        indicator.textContent = 'üõ°Ô∏è Seguridad activa';
                    }
                }
            }, 30000);
            
            console.log('‚úÖ Sistema de seguridad listo');
        });

        // =========================
        // üöÄ NUEVAS FUNCIONALIDADES MEJORADAS
        // =========================
        
        // Sistema de archivos mejorado
        let selectedFiles = [];
        let isFileUploadOpen = false;
        
        function toggleFileUpload() {
            const area = document.getElementById('fileUploadArea');
            isFileUploadOpen = !isFileUploadOpen;
            area.classList.toggle('hidden', !isFileUploadOpen);
            
            if (isFileUploadOpen) {
                setupFileDragAndDrop();
            }
        }
        
        function setupFileDragAndDrop() {
            const area = document.getElementById('fileUploadArea');
            const input = document.getElementById('fileInput');
            
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });
            
            area.addEventListener('dragleave', () => {
                area.classList.remove('dragover');
            });
            
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
            
            input.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }
        
        function handleFiles(files) {
            for (let file of files) {
                if (file.size > 10 * 1024 * 1024) { // 10MB l√≠mite
                    mostrarNotificacion(`El archivo ${file.name} es muy grande (m√°ximo 10MB)`, 'error');
                    continue;
                }
                
                selectedFiles.push(file);
                mostrarVistaPrevia(file);
            }
        }
        
        function mostrarVistaPrevia(file) {
            const preview = document.getElementById('filePreview');
            const div = document.createElement('div');
            div.className = 'file-item';
            
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                div.appendChild(img);
            } else {
                const icon = document.createElement('div');
                icon.className = 'file-icon';
                icon.textContent = getFileIcon(file.type);
                div.appendChild(icon);
            }
            
            const info = document.createElement('div');
            info.className = 'file-info';
            info.innerHTML = `
                <div class="file-name">${file.name}</div>
                <div class="file-size">${formatFileSize(file.size)}</div>
            `;
            div.appendChild(info);
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'file-remove';
            removeBtn.textContent = '√ó';
            removeBtn.onclick = () => {
                selectedFiles = selectedFiles.filter(f => f !== file);
                div.remove();
            };
            div.appendChild(removeBtn);
            
            preview.appendChild(div);
        }
        
        function getFileIcon(type) {
            if (type.startsWith('image/')) return 'üñºÔ∏è';
            if (type.startsWith('video/')) return 'üé•';
            if (type.startsWith('audio/')) return 'üéµ';
            if (type.includes('pdf')) return 'üìÑ';
            if (type.includes('word')) return 'üìù';
            return 'üìÅ';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Sistema de menciones
        let mentionPopup = null;
        let mentionUsers = [];
        
        function detectarMenciones(texto) {
            const cursorPos = document.getElementById('messageInput').selectionStart;
            const textoHastaCursor = texto.slice(0, cursorPos);
            const ultimaArroba = textoHastaCursor.lastIndexOf('@');
            
            if (ultimaArroba !== -1 && ultimaArroba === textoHastaCursor.length - 1) {
                mostrarPopupMenciones();
            } else if (ultimaArroba !== -1) {
                const busqueda = textoHastaCursor.slice(ultimaArroba + 1);
                if (busqueda.length > 0) {
                    filtrarMenciones(busqueda);
                }
            } else {
                ocultarPopupMenciones();
            }
        }
        
        function mostrarPopupMenciones() {
            if (mentionPopup) return;
            
            const input = document.getElementById('messageInput');
            mentionPopup = document.createElement('div');
            mentionPopup.className = 'mention-popup';
            
            // Obtener usuarios conectados para menciones
            mentionUsers = Array.from(connectedUsers);
            
            mentionUsers.forEach(user => {
                const item = document.createElement('div');
                item.className = 'mention-item';
                item.innerHTML = `
                    <div class="user-status online"></div>
                    <span>${user}</span>
                `;
                item.onclick = () => insertarMencion(user);
                mentionPopup.appendChild(item);
            });
            
            input.parentNode.style.position = 'relative';
            input.parentNode.appendChild(mentionPopup);
        }
        
        function filtrarMenciones(busqueda) {
            if (!mentionPopup) return;
            
            const items = mentionPopup.querySelectorAll('.mention-item');
            items.forEach(item => {
                const texto = item.textContent.toLowerCase();
                item.style.display = texto.includes(busqueda.toLowerCase()) ? 'flex' : 'none';
            });
        }
        
        function insertarMencion(usuario) {
            const input = document.getElementById('messageInput');
            const texto = input.value;
            const cursorPos = input.selectionStart;
            const ultimaArroba = texto.slice(0, cursorPos).lastIndexOf('@');
            
            const nuevoTexto = texto.slice(0, ultimaArroba) + `@${usuario} ` + texto.slice(cursorPos);
            input.value = nuevoTexto;
            input.focus();
            
            ocultarPopupMenciones();
        }
        
        function ocultarPopupMenciones() {
            if (mentionPopup) {
                mentionPopup.remove();
                mentionPopup = null;
            }
        }
        
        // Sistema de mensajes de voz
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingTimer = null;
        let recordingStartTime = 0;
        
        async function toggleVoiceRecording() {
            if (!isRecording) {
                await iniciarGrabacion();
            } else {
                detenerGrabacion();
            }
        }
        
        async function iniciarGrabacion() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    procesarAudioGrabado(audioBlob);
                };
                
                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();
                
                const btn = document.getElementById('voiceBtn');
                const timer = document.getElementById('voiceRecordTime');
                btn.classList.add('recording');
                timer.classList.remove('hidden');
                
                recordingTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    timer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
                
            } catch (error) {
                mostrarNotificacion('‚ùå No se pudo acceder al micr√≥fono', 'error');
            }
        }
        
        function detenerGrabacion() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                isRecording = false;
                clearInterval(recordingTimer);
                
                const btn = document.getElementById('voiceBtn');
                const timer = document.getElementById('voiceRecordTime');
                btn.classList.remove('recording');
                timer.classList.add('hidden');
            }
        }
        
        function procesarAudioGrabado(audioBlob) {
            const reader = new FileReader();
            reader.onload = () => {
                const audioData = reader.result;
                const duracion = Math.floor((Date.now() - recordingStartTime) / 1000);
                
                enviarMensajeVoz(audioData, duracion);
            };
            reader.readAsDataURL(audioBlob);
        }
        
        function enviarMensajeVoz(audioData, duracion) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                enviarAlServidor({
                    tipo: 'mensaje_voz',
                    usuario: currentUser,
                    audio: audioData,
                    duracion: duracion,
                    canal: currentChannel,
                    timestamp: new Date().toISOString()
                });
                
                mostrarNotificacion('üé§ Mensaje de voz enviado', 'success');
            }
        }
        
        // Sistema de notificaciones push mejorado
        function solicitarPermisoNotificaciones() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        mostrarNotificacion('üîî Notificaciones activadas', 'success');
                    }
                });
            }
        }
        
        function mostrarNotificacionPush(titulo, mensaje, usuario = null) {
            if (Notification.permission === 'granted' && document.hidden) {
                const notification = new Notification(titulo, {
                    body: mensaje,
                    icon: 'üçá',
                    badge: 'üçá',
                    tag: 'chat-message'
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
                
                setTimeout(() => notification.close(), 5000);
            }
        }
        
        // Inicializar nuevas funcionalidades
        document.addEventListener('DOMContentLoaded', () => {
            solicitarPermisoNotificaciones();
            
            // Inicializar sistema de administraci√≥n seguro
            inicializarSistemaAdmin();
        });
        
        function inicializarSistemaAdmin() {
            // Verificar si hay sesiones expiradas
            setInterval(() => {
                for (const [usuario, session] of adminSessions.entries()) {
                    if (session.expira < Date.now()) {
                        adminSessions.delete(usuario);
                        adminTokens.delete(session.token);
                        if (usuario === currentUser) {
                            currentAdminLevel = null;
                            mostrarNotificacion('‚è∞ Sesi√≥n de administrador expirada', 'warning');
                        }
                    }
                }
            }, 60000); // Verificar cada minuto
            
            // Limpiar intentos fallidos antiguos
            setInterval(() => {
                const ahora = Date.now();
                for (const [key, data] of failedAdminAttempts.entries()) {
                    if (ahora - data.lastAttempt > securityConfig.adminSystem.lockoutDuration) {
                        failedAdminAttempts.delete(key);
                    }
                }
            }, 300000); // Limpiar cada 5 minutos
        }
        
        // Funciones adicionales para el panel de administraci√≥n
        function mostrarUsuariosConectados() {
            const usuarios = Array.from(connectedUsers).map(user => {
                const session = adminSessions.get(user);
                return `${user} ${session ? `(${session.nivel})` : '(usuario)'}`;
            }).join('\n');
            
            alert(`üë• USUARIOS CONECTADOS (${connectedUsers.size}):\n\n${usuarios}`);
        }
        
        function mostrarLogsSeguridad() {
            const logs = auditLogs.slice(-10).map(log => 
                `[${new Date(log.timestamp).toLocaleTimeString()}] ${log.evento}: ${log.usuario} - ${log.detalles}`
            ).join('\n');
            
            alert(`üìä LOGS DE SEGURIDAD (√öltimos 10):\n\n${logs}`);
        }
        
        function mostrarActividadSospechosa() {
            const sospechosa = auditLogs.filter(log => 
                ['SPAM_DETECTED', 'ADMIN_AUTH_FAILED', 'INTRUSION_ALERT'].includes(log.evento)
            ).slice(-5);
            
            const texto = sospechosa.map(log => 
                `[${new Date(log.timestamp).toLocaleTimeString()}] ${log.evento}: ${log.usuario}`
            ).join('\n');
            
            alert(`‚ö†Ô∏è ACTIVIDAD SOSPECHOSA:\n\n${texto || 'No hay actividad sospechosa reciente'}`);
        }
        
        function actualizarCodigosAdmin() {
            if (!esAdministrador('super')) {
                mostrarNotificacion('üö´ Solo super administradores pueden gestionar c√≥digos', 'error');
                return;
            }
            
            const accion = prompt('Acciones disponibles:\n1. Ver c√≥digos\n2. Generar nuevo c√≥digo\n3. Revocar c√≥digo\n\nIngresa el n√∫mero:');
            
            switch(accion) {
                case '1':
                    const codigos = Object.keys(securityConfig.adminSystem.adminCodes).map(codigo => 
                        `${codigo}: ${securityConfig.adminSystem.adminCodes[codigo].nivel} (${securityConfig.adminSystem.adminCodes[codigo].usuario})`
                    ).join('\n');
                    alert(`üîë C√ìDIGOS ACTIVOS:\n\n${codigos}`);
                    break;
                    
                case '2':
                    generarNuevoCodigoAdmin();
                    break;
                    
                case '3':
                    revocarCodigoAdmin();
                    break;
                    
                default:
                    mostrarNotificacion('‚ùå Acci√≥n inv√°lida', 'error');
            }
        }
        
        function generarNuevoCodigoAdmin() {
            const usuario = prompt('Usuario para el nuevo c√≥digo:');
            const nivel = prompt('Nivel (super/moderador):');
            const dias = parseInt(prompt('D√≠as de validez:')) || 30;
            
            if (!usuario || !['super', 'moderador'].includes(nivel)) {
                mostrarNotificacion('‚ùå Datos inv√°lidos', 'error');
                return;
            }
            
            const nuevoCodigo = `GRAPE-${nivel.toUpperCase()}-${Date.now().toString(36).toUpperCase()}`;
            const expira = Date.now() + (dias * 24 * 60 * 60 * 1000);
            
            securityConfig.adminSystem.adminCodes[nuevoCodigo] = {
                usuario: usuario,
                nivel: nivel,
                expira: expira
            };
            
            alert(`‚úÖ NUEVO C√ìDIGO GENERADO:\n\nC√≥digo: ${nuevoCodigo}\nUsuario: ${usuario}\nNivel: ${nivel}\nExpira: ${new Date(expira).toLocaleDateString()}\n\n‚ö†Ô∏è Guarda este c√≥digo de forma segura`);
            
            registrarAuditoria('ADMIN_CODE_GENERATED', currentUser, `Nuevo c√≥digo para ${usuario} (${nivel})`);
        }
        
        function revocarCodigoAdmin() {
            const codigos = Object.keys(securityConfig.adminSystem.adminCodes);
            const codigoToRevoke = prompt(`C√≥digos disponibles:\n${codigos.join('\n')}\n\nIngresa el c√≥digo a revocar:`);
            
            if (securityConfig.adminSystem.adminCodes[codigoToRevoke]) {
                delete securityConfig.adminSystem.adminCodes[codigoToRevoke];
                mostrarNotificacion('‚úÖ C√≥digo revocado exitosamente', 'success');
                registrarAuditoria('ADMIN_CODE_REVOKED', currentUser, `C√≥digo revocado: ${codigoToRevoke.substring(0, 10)}...`);
            } else {
                mostrarNotificacion('‚ùå C√≥digo no encontrado', 'error');
            }
        }
        
        // Comando para acceso r√°pido de administrador
        function comandoAdmin() {
            if (currentAdminLevel) {
                mostrarPanelAdminSeguro();
            } else {
                solicitarAutenticacionAdmin();
            }
        }
    </script>
</body>
</html>
